<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sing-box Config Partner</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.twind.style" crossorigin></script>
    <script>
        // Twind ÈÖçÁΩÆ - Material Design 3 È£éÊ†º
        twind.install({
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // MD3 Color Tokens - Clean Light Theme
                        primary: {
                            DEFAULT: '#005FB0', // Professional Blue
                            container: '#D6E3FF',
                            dark: '#A8C8FF',
                            'dark-container': '#004786'
                        },
                        surface: {
                            DEFAULT: '#FFFFFF', // Pure White background
                            container: '#F0F2F5', // Soft neutral grey
                            'container-high': '#E7E9ED', // Input background
                            'container-highest': '#DDE0E5',
                            dark: '#1A1C1E',
                            'dark-container': '#2E3033',
                            'dark-container-high': '#393B3E',
                            'dark-container-highest': '#44474A'
                        },
                        outline: {
                            DEFAULT: '#74777F',
                            variant: '#C4C6D0',
                            dark: '#8E9099',
                            'dark-variant': '#44474E'
                        }
                    },
                    borderRadius: {
                        'md3-xs': '4px',
                        'md3-sm': '8px',
                        'md3': '12px',
                        'md3-lg': '16px',
                        'md3-xl': '28px',
                        'md3-full': '9999px'
                    },
                    boxShadow: {
                        'md3-1': '0 1px 2px 0 rgba(0, 0, 0, 0.3), 0 1px 3px 1px rgba(0, 0, 0, 0.15)',
                        'md3-2': '0 1px 2px 0 rgba(0, 0, 0, 0.3), 0 2px 6px 2px rgba(0, 0, 0, 0.15)',
                        'md3-3': '0 4px 8px 3px rgba(0, 0, 0, 0.15), 0 1px 3px rgba(0, 0, 0, 0.3)',
                        'md3-4': '0 6px 10px 4px rgba(0, 0, 0, 0.15), 0 2px 3px rgba(0, 0, 0, 0.3)',
                        'md3-5': '0 8px 12px 6px rgba(0, 0, 0, 0.15), 0 4px 4px rgba(0, 0, 0, 0.3)'
                    }
                }
            }
        });
    </script>
</head>

<body class="bg-surface dark:bg-surface-dark transition-colors duration-300">
    <div id="app" class="flex h-screen overflow-hidden antialiased text-gray-900 dark:text-gray-100">

        <aside
            class="w-72 flex-shrink-0 bg-surface-container dark:bg-surface-dark-container flex flex-col shadow-md3-1">
            <div class="p-6 flex justify-between items-center">
                <div>
                    <h1 class="font-bold text-2xl tracking-tight text-primary dark:text-primary-dark">SingBox</h1>
                    <p class="text-xs text-outline dark:text-outline-dark mt-0.5">Config Editor</p>
                </div>
                <button @click="toggleDarkMode"
                    class="p-3 rounded-md3-full bg-primary-container dark:bg-primary-dark-container hover:shadow-md3-2 transition-all">
                    <span v-if="isDark" class="text-lg">üåô</span><span v-else class="text-lg">‚òÄÔ∏è</span>
                </button>
            </div>

            <nav class="flex-1 overflow-y-auto px-3 py-2 space-y-1">
                <button v-for="tab in tabs" :key="tab.id" @click="scrollToSection(tab.id)"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-md3-full transition-all duration-200 hover:bg-surface-container-high dark:hover:bg-surface-dark-container-high text-left group">
                    <span class="text-xl group-hover:scale-110 transition-transform">{{ tab.icon }}</span>
                    <span class="font-medium text-sm">{{ tab.name }}</span>
                </button>
            </nav>

            <div class="p-4 border-t border-outline-variant dark:border-outline-dark-variant">
                <div
                    class="text-[10px] text-outline dark:text-outline-dark uppercase tracking-widest text-center font-medium">
                    Material Design 3</div>
            </div>
        </aside>

        <main class="flex-1 flex overflow-hidden">

            <section class="w-1/2 overflow-y-auto p-6 bg-surface dark:bg-surface-dark scroll-smooth"
                id="editor-container">

                <div v-if="!configLoaded" class="flex items-center justify-center h-full">
                    <div class="text-center">
                        <div class="text-4xl mb-4">‚è≥</div>
                        <p class="text-lg font-medium text-outline dark:text-outline-dark">Âä†ËΩΩÈÖçÁΩÆ‰∏≠...</p>
                    </div>
                </div>

                <div v-else>

                    <div id="section-log" class="mb-6 scroll-mt-6">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="text-3xl">üìù</span>
                            <h2 class="text-2xl font-bold text-primary dark:text-primary-dark">Logging</h2>
                        </div>
                        <div class="space-y-3">
                            <div
                                class="p-5 rounded-md3-lg bg-surface-container dark:bg-surface-dark-container shadow-md3-1 space-y-4 hover:shadow-md3-2 transition-all">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-medium text-base">Disabled</p>
                                        <p class="text-xs text-outline dark:text-outline-dark mt-1">ÊòØÂê¶Á¶ÅÁî®Êó•ÂøóËæìÂá∫</p>
                                    </div>
                                    <input type="checkbox" v-model="config[0].log.disabled"
                                        class="w-6 h-6 rounded-md3-sm accent-primary dark:accent-primary-dark">
                                </div>

                                <div class="border-t border-outline-variant dark:border-outline-dark-variant pt-4">
                                    <label
                                        class="block text-sm font-medium mb-3 text-outline dark:text-outline-dark">Level
                                        : Á∫ßÂà´</label>
                                    <select v-model="config[0].log.level"
                                        class="w-full bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors">
                                        <option v-for="opt in options.levels" :value="opt">{{opt}}</option>
                                    </select>
                                </div>

                                <div class="border-t border-outline-variant dark:border-outline-dark-variant pt-4">
                                    <label
                                        class="block text-sm font-medium mb-3 text-outline dark:text-outline-dark">Output
                                        Path : ËæìÂá∫Ë∑ØÂæÑ</label>
                                    <input v-model="config[0].log.output"
                                        class="w-full bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors"
                                        placeholder="box.log">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="section-dns" class="mb-6 scroll-mt-6">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-3">
                                <span class="text-3xl">üåê</span>
                                <h2 class="text-2xl font-bold text-primary dark:text-primary-dark">DNS Settings</h2>
                            </div>
                        </div>
                        <div class="mb-4">
                            <button @click="uiState.dnsServersExpanded = !uiState.dnsServersExpanded"
                                class="w-full flex items-center justify-between mb-2 group">
                                <h3 class="text-sm font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wide">
                                    Dns ÊúçÂä°Âô® </h3>
                                <svg :class="['w-4 h-4 transition-transform duration-200 text-outline dark:text-outline-dark', uiState.dnsServersExpanded ? 'rotate-180' : '']"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="border-t border-outline-variant dark:border-outline-dark-variant"></div>
                        </div>

                        <div v-show="uiState.dnsServersExpanded" class="space-y-3">
                            <div v-for="(srv, index) in config[0].dns.servers" :key="index"
                                class="p-5 rounded-md3-lg border border-outline-variant dark:border-outline-dark-variant bg-surface-container dark:bg-surface-dark-container shadow-md3-1 hover:shadow-md3-2 transition-all relative group">

                                <div class="mb-4 pb-2 border-b border-outline-variant dark:border-outline-dark-variant">
                                    <span class="font-bold text-lg text-primary dark:text-primary-dark">{{ srv.tag
                                        }}</span>
                                </div>

                                <!-- Type Field (Common) -->
                                <div class="mb-4">
                                    <label class="block text-xs font-medium mb-2 text-outline dark:text-outline-dark">
                                        Type : Á±ªÂûã
                                    </label>
                                    <select v-model="srv.type"
                                        class="w-full bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors appearance-none cursor-pointer">
                                        <option v-for="t in options.dnsServerTypes" :value="t">{{ t }}</option>
                                    </select>
                                </div>

                                <!-- Normal DNS Server Fields -->
                                <template v-if="srv.type !== 'fakeip' && srv.tag !== 'fakeip'">
                                    <div class="space-y-4">
                                        <div>
                                            <label
                                                class="block text-xs font-medium mb-2 text-outline dark:text-outline-dark">
                                                Server : Âú∞ÂùÄ
                                            </label>
                                            <input v-model="srv.server"
                                                class="w-full bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors"
                                                placeholder="1.1.1.1 or https://...">
                                        </div>
                                        <div>
                                            <label
                                                class="block text-xs font-medium mb-2 text-outline dark:text-outline-dark">
                                                Port : Á´ØÂè£
                                            </label>
                                            <input v-model.number="srv.server_port" type="number"
                                                class="w-full bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors"
                                                placeholder="53">
                                        </div>
                                        <div>
                                            <label
                                                class="block text-xs font-medium mb-2 text-outline dark:text-outline-dark">
                                                Detour : Âá∫Á´ô
                                            </label>
                                            <input v-model="srv.detour"
                                                class="w-full bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors"
                                                placeholder="üéØ ÂÖ®ÁêÉÁõ¥Ëøû">
                                        </div>
                                    </div>
                                </template>

                                <!-- FakeIP Fields -->
                                <template v-else>
                                    <div class="space-y-4">
                                        <div>
                                            <label
                                                class="block text-xs font-medium mb-2 text-outline dark:text-outline-dark">Inet4
                                                Range : IPv4 ËåÉÂõ¥</label>
                                            <input v-model="srv.inet4_range"
                                                class="w-full bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors"
                                                placeholder="198.18.0.0/15">
                                        </div>

                                        <div>
                                            <label
                                                class="block text-xs font-medium mb-2 text-outline dark:text-outline-dark">Inet6
                                                Range : IPv6 ËåÉÂõ¥</label>
                                            <input v-model="srv.inet6_range"
                                                class="w-full bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors"
                                                placeholder="fc00::/18">
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <div class="mb-4 mt-6">
                            <button @click="uiState.dnsOtherExpanded = !uiState.dnsOtherExpanded"
                                class="w-full flex items-center justify-between mb-2 group">
                                <h3 class="text-sm font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wide">
                                    ÂÖ∂‰ªñÈÖçÁΩÆ
                                </h3>
                                <svg :class="['w-4 h-4 transition-transform duration-200 text-outline dark:text-outline-dark', uiState.dnsOtherExpanded ? 'rotate-180' : '']"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="border-t border-outline-variant dark:border-outline-dark-variant"></div>
                        </div>

                        <div v-show="uiState.dnsOtherExpanded"
                            class="p-5 rounded-md3-lg bg-surface-container dark:bg-surface-dark-container shadow-md3-1 space-y-4 hover:shadow-md3-2 transition-all">
                            <div>
                                <label class="block text-sm font-medium mb-3 text-outline dark:text-outline-dark">Final
                                    :
                                    ÊúÄÁªàÊúçÂä°Âô®</label>
                                <input v-model="config[0].dns.final"
                                    class="w-full bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors">
                            </div>

                            <div class="border-t border-outline-variant dark:border-outline-dark-variant pt-4">
                                <label class="block text-sm font-medium mb-3 text-outline dark:text-outline-dark">Client
                                    Subnet : ÂÆ¢Êà∑Á´ØÂ≠êÁΩë</label>
                                <input v-model="config[0].dns.client_subnet"
                                    class="w-full bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors"
                                    placeholder="223.5.5.0/24">
                            </div>

                            <div class="border-t border-outline-variant dark:border-outline-dark-variant pt-4">
                                <label
                                    class="block text-sm font-medium mb-3 text-outline dark:text-outline-dark">Strategy
                                    :
                                    Á≠ñÁï•</label>
                                <select v-model="config[0].dns.strategy"
                                    class="w-full bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors">
                                    <option v-for="opt in options.dnsStrategies" :value="opt">{{opt}}</option>
                                </select>
                            </div>

                            <div class="border-t border-outline-variant dark:border-outline-dark-variant pt-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-medium text-base">Independent Cache : Áã¨Á´ãÁºìÂ≠ò</p>
                                        <p class="text-xs text-outline dark:text-outline-dark mt-1">ÊòØÂê¶‰ΩøÁî®Áã¨Á´ãÁºìÂ≠ò</p>
                                    </div>
                                    <input type="checkbox" v-model="config[0].dns.independent_cache"
                                        class="w-6 h-6 rounded-md3-sm accent-primary dark:accent-primary-dark">
                                </div>
                            </div>

                            <div class="border-t border-outline-variant dark:border-outline-dark-variant pt-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="font-medium text-base">Reverse Mapping : ÂèçÂêëÊò†Â∞Ñ</p>
                                        <p class="text-xs text-outline dark:text-outline-dark mt-1">ÂêØÁî®ÂèçÂêë DNS Êò†Â∞Ñ</p>
                                    </div>
                                    <input type="checkbox" v-model="config[0].dns.reverse_mapping"
                                        class="w-6 h-6 rounded-md3-sm accent-primary dark:accent-primary-dark">
                                </div>
                            </div>
                        </div>
                    </div>


                    <div id="section-inbound" class="mb-6 scroll-mt-6">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="text-3xl">üì•</span>
                            <h2 class="text-2xl font-bold text-primary dark:text-primary-dark">Inbounds</h2>
                        </div>

                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <button @click="uiState.inboundsExpanded = !uiState.inboundsExpanded"
                                    class="flex items-center gap-2 group">
                                    <h3
                                        class="text-sm font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wide">
                                        ÂÖ•Á´ôÈÖçÁΩÆ</h3>
                                    <svg :class="['w-4 h-4 transition-transform duration-200 text-outline dark:text-outline-dark', uiState.inboundsExpanded ? 'rotate-180' : '']"
                                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="border-t border-outline-variant dark:border-outline-dark-variant"></div>
                        </div>

                        <div v-show="uiState.inboundsExpanded" class="space-y-3">
                            <div v-for="(inbound, index) in config[0].inbounds" :key="index"
                                class="p-5 rounded-md3-lg border border-outline-variant dark:border-outline-dark-variant bg-surface-container dark:bg-surface-dark-container shadow-md3-1 hover:shadow-md3-2 transition-all relative group">

                                <div
                                    class="flex items-center justify-between mb-3 pb-3 border-b border-outline-variant dark:border-outline-dark-variant">
                                    <div
                                        class="inline-block px-3 py-1.5 bg-primary-container dark:bg-primary-dark-container rounded-md3-full">
                                        <span class="font-bold text-xs uppercase">{{ inbound.type || 'unknown' }}</span>
                                    </div>
                                    <button @click.stop="deleteInbound(index)"
                                        class="w-8 h-8 flex items-center justify-center rounded-md3-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors opacity-0 group-hover:opacity-100">
                                        <span class="text-lg">‚úï</span>
                                    </button>
                                </div>

                                <div>
                                    <label class="text-xs font-medium text-outline dark:text-outline-dark block mb-2">ÈÖçÁΩÆ
                                        JSON</label>
                                    <textarea :value="JSON.stringify(inbound, null, 2)"
                                        @input="updateInbound(index, $event.target.value)"
                                        class="w-full h-48 font-mono text-xs bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors resize-y"
                                        placeholder='{"type": "mixed", "tag": "mixed-in", ...}'></textarea>
                                    <p class="text-xs text-outline dark:text-outline-dark mt-2">Áõ¥Êé•ÁºñËæë JSON ÈÖçÁΩÆÔºå‰øùÂ≠òÊó∂‰ºöËá™Âä®È™åËØÅÊ†ºÂºè
                                    </p>
                                </div>
                            </div>


                            <button @click="addInbound"
                                class="w-full bg-primary dark:bg-primary-dark hover:shadow-md3-3 text-white px-6 py-3 rounded-md3-lg text-sm font-medium transition-all flex items-center justify-center gap-2">
                                <span class="text-lg">+</span>
                                <span>Ê∑ªÂä† Inbound</span>
                            </button>
                        </div>
                    </div>
                    <div id="section-outbound" class="mb-6 scroll-mt-6">
                        <div class="flex items-center gap-3 mb-4">
                            <span class="text-3xl">üì§Ô∏è</span>
                            <h2 class="text-2xl font-bold text-primary dark:text-primary-dark">Outbounds</h2>
                        </div>

                        <!-- Â∫îÁî®ËßÑÂàô -->
                        <div class="mb-4">
                            <button @click="uiState.outboundAppExpanded = !uiState.outboundAppExpanded"
                                class="w-full flex items-center justify-between mb-2 group">
                                <h3 class="text-sm font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wide">
                                    Â∫îÁî®ËßÑÂàô
                                </h3>
                                <svg :class="['w-4 h-4 transition-transform duration-200 text-outline dark:text-outline-dark', uiState.outboundAppExpanded ? 'rotate-180' : '']"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="border-t border-outline-variant dark:border-outline-dark-variant"></div>
                        </div>

                        <div v-show="uiState.outboundAppExpanded" class="space-y-2 mb-6">
                            <div v-for="(outbound, index) in getOutboundsByGroup('Â∫îÁî®ËßÑÂàô')" :key="'app-' + index"
                                class="rounded-md3-lg border border-outline-variant dark:border-outline-dark-variant bg-surface-container dark:bg-surface-dark-container shadow-md3-1 hover:shadow-md3-2 transition-all">
                                <div @click="toggleOutboundExpand(outbound.tag)"
                                    class="p-3 flex items-center justify-between cursor-pointer group">
                                    <div class="flex items-center gap-2 flex-1">
                                        <span class="font-bold text-sm">{{ outbound.tag }}</span>
                                        <span
                                            class="text-xs px-2 py-0.5 rounded-md3-full bg-primary-container dark:bg-primary-dark-container">
                                            {{ outbound.type }}
                                        </span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button @click.stop="removeFromGroup('Â∫îÁî®ËßÑÂàô', outbound.tag)"
                                            class="opacity-0 group-hover:opacity-100 w-6 h-6 flex items-center justify-center rounded-md3-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 transition-all">
                                            <span class="text-sm">‚úï</span>
                                        </button>
                                        <svg :class="['w-4 h-4 transition-transform duration-200', uiState.expandedOutbounds[outbound.tag] ? 'rotate-180' : '']"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div v-show="uiState.expandedOutbounds[outbound.tag]" class="px-3 pb-3">
                                    <textarea :value="JSON.stringify(outbound, null, 2)"
                                        @input="updateOutbound(outbound.tag, $event.target.value)"
                                        class="w-full h-48 bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors font-mono text-xs"
                                        placeholder="JSON configuration"></textarea>
                                </div>
                            </div>
                            <button @click="showAddOutboundModal('Â∫îÁî®ËßÑÂàô')"
                                class="w-full p-2 rounded-md3 border-2 border-dashed border-outline-variant dark:border-outline-dark-variant hover:border-primary dark:hover:border-primary-dark hover:bg-surface-container-high dark:hover:bg-surface-dark-container-high transition-all text-sm text-outline dark:text-outline-dark">
                                + Ê∑ªÂä† Outbound
                            </button>
                        </div>

                        <!-- Âú∞Âå∫ÂàÜÁ±ª -->
                        <div class="mb-4 mt-6">
                            <button @click="uiState.outboundRegionExpanded = !uiState.outboundRegionExpanded"
                                class="w-full flex items-center justify-between mb-2 group">
                                <h3 class="text-sm font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wide">
                                    Âú∞Âå∫ÂàÜÁ±ª
                                </h3>
                                <svg :class="['w-4 h-4 transition-transform duration-200 text-outline dark:text-outline-dark', uiState.outboundRegionExpanded ? 'rotate-180' : '']"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="border-t border-outline-variant dark:border-outline-dark-variant"></div>
                        </div>

                        <div v-show="uiState.outboundRegionExpanded" class="space-y-2 mb-6">
                            <div v-for="(outbound, index) in getOutboundsByGroup('Âú∞Âå∫ÂàÜÁ±ª')" :key="'region-' + index"
                                class="rounded-md3-lg border border-outline-variant dark:border-outline-dark-variant bg-surface-container dark:bg-surface-dark-container shadow-md3-1 hover:shadow-md3-2 transition-all">
                                <div @click="toggleOutboundExpand(outbound.tag)"
                                    class="p-3 flex items-center justify-between cursor-pointer group">
                                    <div class="flex items-center gap-2 flex-1">
                                        <span class="font-bold text-sm">{{ outbound.tag }}</span>
                                        <span
                                            class="text-xs px-2 py-0.5 rounded-md3-full bg-secondary-container dark:bg-secondary-dark-container">
                                            {{ outbound.type }}
                                        </span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button @click.stop="removeFromGroup('Âú∞Âå∫ÂàÜÁ±ª', outbound.tag)"
                                            class="opacity-0 group-hover:opacity-100 w-6 h-6 flex items-center justify-center rounded-md3-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 transition-all">
                                            <span class="text-sm">‚úï</span>
                                        </button>
                                        <svg :class="['w-4 h-4 transition-transform duration-200', uiState.expandedOutbounds[outbound.tag] ? 'rotate-180' : '']"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div v-show="uiState.expandedOutbounds[outbound.tag]" class="px-3 pb-3">
                                    <textarea :value="JSON.stringify(outbound, null, 2)"
                                        @input="updateOutbound(outbound.tag, $event.target.value)"
                                        class="w-full h-48 bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors font-mono text-xs"
                                        placeholder="JSON configuration"></textarea>
                                </div>
                            </div>
                            <button @click="showAddOutboundModal('Âú∞Âå∫ÂàÜÁ±ª')"
                                class="w-full p-2 rounded-md3 border-2 border-dashed border-outline-variant dark:border-outline-dark-variant hover:border-primary dark:hover:border-primary-dark hover:bg-surface-container-high dark:hover:bg-surface-dark-container-high transition-all text-sm text-outline dark:text-outline-dark">
                                + Ê∑ªÂä† Outbound
                            </button>
                        </div>

                        <!-- Âü∫Êú¨ÂàÜÁªÑ -->
                        <div class="mb-4 mt-6">
                            <button @click="uiState.outboundBasicExpanded = !uiState.outboundBasicExpanded"
                                class="w-full flex items-center justify-between mb-1 group">
                                <h3 class="text-sm font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wide">
                                    Âü∫Êú¨ÂàÜÁªÑ
                                </h3>
                                <svg :class="['w-4 h-4 transition-transform duration-200 text-outline dark:text-outline-dark', uiState.outboundBasicExpanded ? 'rotate-180' : '']"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <p
                                class="text-[10px] font-medium text-red-600 dark:text-red-400 mb-2 flex items-center gap-1">
                                <span>‚ö†Ô∏è</span> Âü∫Êú¨ÂàÜÁªÑËØ∑ÂãøÈöèÊÑèÂà†Èô§ÔºåÂèØËÉΩÂØºËá¥ËΩ¨Êç¢Â§±Ë¥•
                            </p>
                            <div class="border-t border-outline-variant dark:border-outline-dark-variant"></div>
                        </div>

                        <div v-show="uiState.outboundBasicExpanded" class="space-y-2 mb-6">
                            <div v-for="(outbound, index) in getOutboundsByGroup('Âü∫Êú¨ÂàÜÁªÑ')" :key="'basic-' + index"
                                class="rounded-md3-lg border border-outline-variant dark:border-outline-dark-variant bg-surface-container dark:bg-surface-dark-container shadow-md3-1 hover:shadow-md3-2 transition-all">
                                <div @click="toggleOutboundExpand(outbound.tag)"
                                    class="p-3 flex items-center justify-between cursor-pointer group">
                                    <div class="flex items-center gap-2 flex-1">
                                        <span class="font-bold text-sm">{{ outbound.tag }}</span>
                                        <span
                                            class="text-xs px-2 py-0.5 rounded-md3-full bg-tertiary-container dark:bg-tertiary-dark-container">
                                            {{ outbound.type }}
                                        </span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button @click.stop="removeFromGroup('Âü∫Êú¨ÂàÜÁªÑ', outbound.tag)"
                                            class="opacity-0 group-hover:opacity-100 w-6 h-6 flex items-center justify-center rounded-md3-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 transition-all">
                                            <span class="text-sm">‚úï</span>
                                        </button>
                                        <svg :class="['w-4 h-4 transition-transform duration-200', uiState.expandedOutbounds[outbound.tag] ? 'rotate-180' : '']"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div v-show="uiState.expandedOutbounds[outbound.tag]" class="px-3 pb-3">
                                    <textarea :value="JSON.stringify(outbound, null, 2)"
                                        @input="updateOutbound(outbound.tag, $event.target.value)"
                                        class="w-full h-48 bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors font-mono text-xs"
                                        placeholder="JSON configuration"></textarea>
                                </div>
                            </div>
                            <button @click="showAddOutboundModal('Âü∫Êú¨ÂàÜÁªÑ')"
                                class="w-full p-2 rounded-md3 border-2 border-dashed border-outline-variant dark:border-outline-dark-variant hover:border-primary dark:hover:border-primary-dark hover:bg-surface-container-high dark:hover:bg-surface-dark-container-high transition-all text-sm text-outline dark:text-outline-dark">
                                + Ê∑ªÂä† Outbound
                            </button>
                        </div>

                        <!-- Ëá™ÂÆö‰πâ Outbound -->
                        <div class="mb-4 mt-6">
                            <button @click="uiState.outboundCustomExpanded = !uiState.outboundCustomExpanded"
                                class="w-full flex items-center justify-between mb-2 group">
                                <h3 class="text-sm font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wide">
                                    Ëá™ÂÆö‰πâ Outbound
                                </h3>
                                <svg :class="['w-4 h-4 transition-transform duration-200 text-outline dark:text-outline-dark', uiState.outboundCustomExpanded ? 'rotate-180' : '']"
                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="border-t border-outline-variant dark:border-outline-dark-variant"></div>
                        </div>

                        <div v-show="uiState.outboundCustomExpanded" class="space-y-2 mb-6">
                            <div v-for="(outbound, index) in getOutboundsByGroup('Ëá™ÂÆö‰πâ')" :key="'custom-' + index"
                                class="rounded-md3-lg border border-outline-variant dark:border-outline-dark-variant bg-surface-container dark:bg-surface-dark-container shadow-md3-1 hover:shadow-md3-2 transition-all">
                                <div @click="toggleOutboundExpand(outbound.tag)"
                                    class="p-3 flex items-center justify-between cursor-pointer group">
                                    <div class="flex items-center gap-2 flex-1">
                                        <span class="font-bold text-sm">{{ outbound.tag }}</span>
                                        <span
                                            class="text-xs px-2 py-0.5 rounded-md3-full bg-error-container dark:bg-error-dark-container">
                                            {{ outbound.type }}
                                        </span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button @click.stop="deleteCustomOutbound(outbound.tag)"
                                            class="opacity-0 group-hover:opacity-100 w-6 h-6 flex items-center justify-center rounded-md3-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 transition-all">
                                            <span class="text-sm">‚úï</span>
                                        </button>
                                        <svg :class="['w-4 h-4 transition-transform duration-200', uiState.expandedOutbounds[outbound.tag] ? 'rotate-180' : '']"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div v-show="uiState.expandedOutbounds[outbound.tag]" class="px-3 pb-3">
                                    <textarea :value="JSON.stringify(outbound, null, 2)"
                                        class="w-full h-48 bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors font-mono text-xs"
                                        placeholder="JSON configuration"></textarea>
                                    <div class="mt-2 flex justify-end">
                                        <button
                                            @click="confirmCustomOutbound(outbound.tag, $event.target.parentElement.previousElementSibling.value)"
                                            class="px-4 py-2 bg-primary dark:bg-primary-dark text-white rounded-md3 text-xs font-bold shadow-md3-1 hover:shadow-md3-2 transition-all">
                                            Á°ÆÂÆöÂπ∂‰øùÂ≠òÔºàËøõÂÖ•Êú™ÂàÜÁ±ªÔºâ
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button @click="createNewOutbound"
                                class="w-full p-3 rounded-md3 bg-primary dark:bg-primary-dark hover:shadow-md3-3 text-white font-medium transition-all flex items-center justify-center gap-2">
                                <span class="text-lg">+</span>
                                <span>ÂàõÂª∫Êñ∞ Outbound</span>
                            </button>
                        </div>


                        <div id="section-route" class="mb-6 scroll-mt-6">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-3xl">üß≠</span>
                                <h2 class="text-2xl font-bold text-primary dark:text-primary-dark">Route</h2>
                            </div>
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p class="font-medium text-base">Github ‰ª£ÁêÜ</p>
                                    <p class="text-xs text-outline dark:text-outline-dark mt-1">ÊòØÂê¶‰ΩøÁî® Github ‰ª£ÁêÜ‰∏ãËΩΩËßÑÂàôÈõÜ</p>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="text" v-model="config[1].githubProxyUrl"
                                        :disabled="!config[1].githubProxy" placeholder="‰ª£ÁêÜÂú∞ÂùÄ (‰æãÂ¶Ç https://gh-proxy.com/)"
                                        class="w-64 text-xs px-3 py-2 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark bg-surface dark:bg-surface-dark outline-none transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                    <input type="checkbox" v-model="config[1].githubProxy"
                                        class="w-6 h-6 rounded-md3-sm accent-primary dark:accent-primary-dark cursor-pointer">
                                </div>
                            </div>
                            <!-- Rule Sets Subsection -->
                            <div class="mb-4">
                                <button @click="uiState.ruleSetsExpanded = !uiState.ruleSetsExpanded"
                                    class="w-full flex items-center justify-between mb-2 group">
                                    <h3
                                        class="text-sm font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wide">
                                        ËßÑÂàôÈõÜ
                                    </h3>
                                    <svg :class="['w-4 h-4 transition-transform duration-200 text-outline dark:text-outline-dark', uiState.ruleSetsExpanded ? 'rotate-180' : '']"
                                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div class="border-t border-outline-variant dark:border-outline-dark-variant"></div>
                            </div>

                            <div v-show="uiState.ruleSetsExpanded" class="space-y-2 mb-6">
                                <div v-for="(ruleset, index) in getRuleSets" :key="'ruleset-' + index"
                                    class="rounded-md3-lg border border-outline-variant dark:border-outline-dark-variant bg-surface-container dark:bg-surface-dark-container shadow-md3-1 hover:shadow-md3-2 transition-all">
                                    <div @click="toggleRuleSetExpand(ruleset.tag)"
                                        class="p-3 flex items-center justify-between cursor-pointer group">
                                        <div class="flex items-center gap-2 flex-1">
                                            <span class="font-bold text-sm">{{ ruleset.tag }}</span>
                                            <span
                                                class="text-xs px-2 py-0.5 rounded-md3-full bg-primary-container dark:bg-primary-dark-container">
                                                {{ ruleset.type }}
                                            </span>
                                            <span
                                                class="text-xs px-2 py-0.5 rounded-md3-full bg-secondary-container dark:bg-secondary-dark-container">
                                                {{ ruleset.format }}
                                            </span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <button @click.stop="deleteRuleSet(ruleset.tag)"
                                                class="opacity-0 group-hover:opacity-100 w-6 h-6 flex items-center justify-center rounded-md3-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 transition-all">
                                                <span class="text-sm">‚úï</span>
                                            </button>
                                            <svg :class="['w-4 h-4 transition-transform duration-200', uiState.expandedRuleSets[ruleset.tag] ? 'rotate-180' : '']"
                                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                    </div>

                                    <!-- Bound Outbound Display (when collapsed) -->
                                    <div v-if="!uiState.expandedRuleSets[ruleset.tag] && getRulesetOutbounds(ruleset.tag)"
                                        class="px-3 pb-3 flex flex-wrap gap-1">
                                        <span
                                            class="text-xs px-2 py-1 rounded-md3-full bg-tertiary-container dark:bg-tertiary-dark-container">
                                            {{ getRulesetOutbounds(ruleset.tag) }}
                                        </span>
                                    </div>

                                    <!-- Expanded View -->
                                    <div v-show="uiState.expandedRuleSets[ruleset.tag]" class="px-3 pb-3 space-y-3">
                                        <!-- Outbound Binding Interface -->
                                        <div class="space-y-2">
                                            <label class="text-xs font-medium text-outline dark:text-outline-dark">ÁªëÂÆö
                                                Outbounds:</label>
                                            <div
                                                class="flex flex-wrap gap-2 p-2 bg-surface-container-high dark:bg-surface-dark-container-high rounded-md3 border border-outline-variant dark:border-outline-dark-variant">
                                                <span v-if="getRulesetOutbounds(ruleset.tag)"
                                                    class="inline-flex items-center gap-1 text-xs px-2 py-1 rounded-md3-full bg-tertiary-container dark:bg-tertiary-dark-container group/tag cursor-pointer"
                                                    @click="unbindOutboundFromRuleset(ruleset.tag)">
                                                    {{ getRulesetOutbounds(ruleset.tag) }}
                                                    <span
                                                        class="opacity-0 group-hover/tag:opacity-100 transition-opacity">‚úï</span>
                                                </span>
                                                <div class="flex items-center gap-2 flex-1">
                                                    <input v-model="uiState.manualOutboundInput[ruleset.tag]"
                                                        @keyup.enter="bindManualOutbound(ruleset.tag)" type="text"
                                                        placeholder="ÊâãÂä®ËæìÂÖ• outbound ÂêçÁß∞..."
                                                        class="flex-1 text-xs px-2 py-1 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none bg-surface dark:bg-surface-dark" />
                                                    <button @click="bindManualOutbound(ruleset.tag)"
                                                        class="text-xs px-2 py-1 rounded-md3 bg-secondary-container dark:bg-secondary-dark-container hover:shadow-md3-1 transition-all">
                                                        Á°ÆÂÆö
                                                    </button>
                                                </div>
                                                <button
                                                    @click="uiState.currentRulesetForBinding = ruleset.tag; uiState.showOutboundSelectorModal = true"
                                                    class="text-xs px-2 py-1 rounded-md3-full border border-dashed border-outline-variant dark:border-outline-dark-variant hover:border-primary dark:hover:border-primary-dark transition-colors">
                                                    + Ê∑ªÂä†
                                                </button>
                                            </div>
                                        </div>

                                        <!-- JSON Editor -->
                                        <div>
                                            <label class="text-xs font-medium text-outline dark:text-outline-dark">JSON
                                                ÈÖçÁΩÆ:</label>
                                            <textarea :value="JSON.stringify(ruleset, null, 2)"
                                                @input="updateRuleSet(ruleset.tag, $event.target.value)"
                                                class="w-full h-32 mt-1 bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors font-mono text-xs"
                                                placeholder="JSON configuration"></textarea>
                                        </div>
                                    </div>
                                </div>
                                <button @click="createNewRuleSet"
                                    class="w-full p-3 rounded-md3 bg-primary dark:bg-primary-dark hover:shadow-md3-3 text-white font-medium transition-all flex items-center justify-center gap-2">
                                    <span class="text-lg">+</span>
                                    <span>ÂàõÂª∫Êñ∞ Rule Set</span>
                                </button>
                            </div>
                        </div>
                        <div id="section-experimental" class="mb-6 scroll-mt-6">
                            <div class="flex items-center gap-3 mb-4">
                                <span class="text-3xl">üß™</span>
                                <h2 class="text-2xl font-bold text-primary dark:text-primary-dark">Experimental</h2>
                            </div>

                            <div class="mb-4">
                                <button @click="uiState.experimentalExpanded = !uiState.experimentalExpanded"
                                    class="w-full flex items-center justify-between mb-2 group">
                                    <h3
                                        class="text-sm font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wide">
                                        ÂÆûÈ™åÊÄßÂäüËÉΩ
                                    </h3>
                                    <svg :class="['w-4 h-4 transition-transform duration-200 text-outline dark:text-outline-dark', uiState.experimentalExpanded ? 'rotate-180' : '']"
                                        fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div class="border-t border-outline-variant dark:border-outline-dark-variant"></div>
                            </div>

                            <div v-show="uiState.experimentalExpanded" class="space-y-6">
                                <!-- Clash API -->
                                <div class="mb-4 p-4 rounded-md3-lg bg-surface-container dark:bg-surface-dark-container border border-outline-variant dark:border-outline-dark-variant shadow-md3-1"
                                    v-if="config[0].experimental?.clash_api">
                                    <div class="flex items-center gap-2 mb-4">
                                        <h3 class="font-medium text-lg text-primary dark:text-primary-dark">Clash API
                                        </h3>
                                    </div>

                                    <div class="space-y-4">
                                        <!-- External Controller -->
                                        <div>
                                            <label
                                                class="block text-xs font-medium text-outline dark:text-outline-dark mb-1">External
                                                Controller : ÁõëÂê¨Âú∞ÂùÄ</label>
                                            <input type="text"
                                                v-model="config[0].experimental.clash_api.external_controller"
                                                class="w-full text-sm px-3 py-2 rounded-md3 border border-outline-variant dark:border-outline-dark-variant bg-surface dark:bg-surface-dark focus:border-primary dark:focus:border-primary-dark outline-none transition-all">
                                        </div>

                                        <!-- External UI -->
                                        <div>
                                            <label
                                                class="block text-xs font-medium text-outline dark:text-outline-dark mb-1">External
                                                UI : UI Ë∑ØÂæÑ</label>
                                            <input type="text" v-model="config[0].experimental.clash_api.external_ui"
                                                class="w-full text-sm px-3 py-2 rounded-md3 border border-outline-variant dark:border-outline-dark-variant bg-surface dark:bg-surface-dark focus:border-primary dark:focus:border-primary-dark outline-none transition-all">
                                        </div>

                                        <!-- Download URL -->
                                        <div>
                                            <label
                                                class="block text-xs font-medium text-outline dark:text-outline-dark mb-1">UI
                                                Download URL : ‰∏ãËΩΩÂú∞ÂùÄ</label>
                                            <input type="text"
                                                v-model="config[0].experimental.clash_api.external_ui_download_url"
                                                class="w-full text-sm px-3 py-2 rounded-md3 border border-outline-variant dark:border-outline-dark-variant bg-surface dark:bg-surface-dark focus:border-primary dark:focus:border-primary-dark outline-none transition-all">
                                        </div>

                                        <!-- Download Detour -->
                                        <div>
                                            <label
                                                class="block text-xs font-medium text-outline dark:text-outline-dark mb-1">Download
                                                Detour : ‰∏ãËΩΩ‰ª£ÁêÜ</label>
                                            <input type="text"
                                                v-model="config[0].experimental.clash_api.external_ui_download_detour"
                                                class="w-full text-sm px-3 py-2 rounded-md3 border border-outline-variant dark:border-outline-dark-variant bg-surface dark:bg-surface-dark focus:border-primary dark:focus:border-primary-dark outline-none transition-all">
                                        </div>

                                        <!-- Default Mode -->
                                        <div>
                                            <label
                                                class="block text-xs font-medium text-outline dark:text-outline-dark mb-1">Default
                                                Mode : ÈªòËÆ§Ê®°Âºè</label>
                                            <select v-model="config[0].experimental.clash_api.default_mode"
                                                class="w-full text-sm px-3 py-2 rounded-md3 border border-outline-variant dark:border-outline-dark-variant bg-surface dark:bg-surface-dark focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-all appearance-none cursor-pointer">
                                                <option v-for="mode in ['rule', 'global', 'direct']" :value="mode">{{
                                                    mode }}</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Cache File -->
                                <div class="mb-4 p-4 rounded-md3-lg bg-surface-container dark:bg-surface-dark-container border border-outline-variant dark:border-outline-dark-variant shadow-md3-1"
                                    v-if="config[0].experimental?.cache_file">
                                    <div class="flex items-center gap-2 mb-4">
                                        <h3 class="font-medium text-lg text-primary dark:text-primary-dark">Cache File
                                        </h3>
                                    </div>

                                    <div class="flex flex-col gap-4">
                                        <!-- Enabled -->
                                        <div
                                            class="flex items-center justify-between p-3 rounded-md3 bg-surface dark:bg-surface-dark border border-outline-variant dark:border-outline-dark-variant">
                                            <div>
                                                <p class="font-medium text-sm">Enabled</p>
                                                <p class="text-xs text-outline dark:text-outline-dark">ÊòØÂê¶ÂêØÁî®ÁºìÂ≠òÊñá‰ª∂</p>
                                            </div>
                                            <input type="checkbox" v-model="config[0].experimental.cache_file.enabled"
                                                class="w-5 h-5 rounded-md3-sm accent-primary dark:accent-primary-dark cursor-pointer">
                                        </div>

                                        <!-- Store FakeIP -->
                                        <div
                                            class="flex items-center justify-between p-3 rounded-md3 bg-surface dark:bg-surface-dark border border-outline-variant dark:border-outline-dark-variant">
                                            <div>
                                                <p class="font-medium text-sm">Store FakeIP</p>
                                                <p class="text-xs text-outline dark:text-outline-dark">ÊòØÂê¶Â≠òÂÇ® FakeIP Êò†Â∞Ñ
                                                </p>
                                            </div>
                                            <input type="checkbox"
                                                v-model="config[0].experimental.cache_file.store_fakeip"
                                                class="w-5 h-5 rounded-md3-sm accent-primary dark:accent-primary-dark cursor-pointer">
                                        </div>

                                        <!-- Path -->
                                        <div>
                                            <label
                                                class="block text-xs font-medium text-outline dark:text-outline-dark mb-1">Path</label>
                                            <input type="text" v-model="config[0].experimental.cache_file.path"
                                                placeholder="cache.db"
                                                class="w-full text-sm px-3 py-2 rounded-md3 border border-outline-variant dark:border-outline-dark-variant bg-surface dark:bg-surface-dark focus:border-primary dark:focus:border-primary-dark outline-none transition-all">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="section-filter" class="mb-6 scroll-mt-6">
                                <div class="flex items-center gap-3 mb-4">
                                    <span class="text-3xl">üï∏</span>
                                    <h2 class="text-2xl font-bold text-primary dark:text-primary-dark">Filter</h2>
                                </div>

                                <div class="mb-4">
                                    <button @click="uiState.filterExpanded = !uiState.filterExpanded"
                                        class="w-full flex items-center justify-between mb-2 group">
                                        <h3
                                            class="text-sm font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wide">
                                            ËøáÊª§ËßÑÂàô
                                        </h3>
                                        <svg :class="['w-4 h-4 transition-transform duration-200 text-outline dark:text-outline-dark', uiState.filterExpanded ? 'rotate-180' : '']"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="border-t border-outline-variant dark:border-outline-dark-variant"></div>
                                </div>

                                <div v-show="uiState.filterExpanded" class="flex flex-col gap-6">
                                    <!-- Fetch & Preview -->
                                    <div
                                        class="p-4 rounded-md3-lg bg-surface-container dark:bg-surface-dark-container border border-outline-variant dark:border-outline-dark-variant shadow-md3-1">
                                        <h3 class="font-medium text-lg text-primary dark:text-primary-dark mb-3">ÊäìÂèñÂπ∂È¢ÑËßà
                                        </h3>
                                        <div class="space-y-4">
                                            <div class="flex gap-2">
                                                <input type="text" v-model="uiState.importUrl"
                                                    placeholder="ËæìÂÖ•ËÆ¢ÈòÖÈìæÊé•‰ª•È¢ÑËßàËøáÊª§ÊïàÊûú..."
                                                    class="flex-1 bg-surface dark:bg-surface-dark p-2.5 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors text-sm">
                                                <button @click="fetchProxies" :disabled="uiState.importing"
                                                    class="px-5 py-2 bg-primary dark:bg-primary-dark text-white rounded-md3 hover:shadow-md3-2 transition-all disabled:opacity-50 text-sm font-medium">
                                                    {{ uiState.importing ? '...' : 'Ëé∑Âèñ' }}
                                                </button>
                                            </div>

                                            <div v-if="uiState.fetchedNodes && uiState.fetchedNodes.length > 0"
                                                class="mt-4">
                                                <div class="flex items-center justify-between mb-2">
                                                    <span class="text-xs font-medium text-outline">Â∑≤ÊäìÂèñ {{
                                                        uiState.fetchedNodes.length }} ‰∏™ËäÇÁÇπ</span>
                                                    <button @click="mergeFetchedNodes"
                                                        class="text-xs text-primary dark:text-primary-dark font-bold hover:underline">ÂêàÂπ∂Âà∞ÈÖçÁΩÆ</button>
                                                </div>
                                                <div
                                                    class="max-h-40 overflow-y-auto border border-outline-variant dark:border-outline-dark-variant rounded-md3 bg-surface-container-low dark:bg-surface-dark-container-low p-2">
                                                    <div v-for="node in uiState.fetchedNodes" :key="node.tag"
                                                        class="text-[10px] py-0.5 px-1 font-mono truncate border-b border-outline-variant last:border-0 opacity-70">
                                                        {{ node.tag }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Node Group Filter -->
                                    <div
                                        class="p-4 rounded-md3-lg bg-surface-container dark:bg-surface-dark-container border border-outline-variant dark:border-outline-dark-variant shadow-md3-1">
                                        <div class="flex items-center justify-between mb-4">
                                            <h3 class="font-medium text-lg text-primary dark:text-primary-dark">Node
                                                Group
                                                Filter
                                            </h3>
                                            <button @click="addFilterRule"
                                                class="text-xs bg-primary dark:bg-primary-dark text-white px-3 py-1.5 rounded-md3-full hover:shadow-md3-2 transition-shadow">
                                                Ôºã Ê∑ªÂä†ËßÑÂàô
                                            </button>
                                        </div>

                                        <div class="space-y-3">
                                            <div v-for="(rule, index) in config[1].filter?.country_filter" :key="index"
                                                class="p-3 bg-surface dark:bg-surface-dark rounded-md3 border border-outline-variant dark:border-outline-dark-variant">
                                                <div class="flex items-center justify-between mb-2 gap-2">
                                                    <div class="flex-1">
                                                        <label
                                                            class="block text-xs text-outline dark:text-outline-dark mb-1">ÁõÆÊ†áÂàÜÁªÑ
                                                            (Outbound)</label>
                                                        <div class="flex gap-2">
                                                            <input type="text" v-model="rule.outbound"
                                                                placeholder="‰æãÂ¶Ç: È¶ôÊ∏ØËäÇÁÇπ"
                                                                class="flex-1 text-sm px-2 py-1.5 rounded-md3 border border-outline-variant dark:border-outline-dark-variant bg-surface-container-low dark:bg-surface-dark-container-low focus:border-primary dark:focus:border-primary-dark outline-none transition-all">
                                                            <button @click="openFilterOutboundSelector(index)"
                                                                class="px-3 py-1.5 bg-surface-container-high dark:bg-surface-dark-container-high rounded-md3 text-xs hover:bg-surface-container-highest transition-colors font-medium">
                                                                ÈÄâÊã©
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <button @click="removeFilterRule(index)"
                                                        class="text-error hover:text-error-dark p-1 self-start mt-6 transition-colors"
                                                        title="Âà†Èô§ËßÑÂàô">
                                                        <svg class="w-5 h-5" fill="none" stroke="currentColor"
                                                            viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                                            </path>
                                                        </svg>
                                                    </button>
                                                </div>
                                                <div>
                                                    <label
                                                        class="block text-xs text-outline dark:text-outline-dark mb-1">ÂåπÈÖçËßÑÂàô
                                                        (Regex)</label>
                                                    <input type="text" v-model="rule.regex"
                                                        placeholder="(?i)hk|hongkong"
                                                        class="w-full text-sm px-2 py-1.5 rounded-md3 border border-outline-variant dark:border-outline-dark-variant bg-surface-container-low dark:bg-surface-dark-container-low focus:border-primary dark:focus:border-primary-dark outline-none font-mono transition-all">
                                                </div>

                                                <!-- Real-time Preview -->
                                                <div v-if="getFilteredNodesPreview(rule.regex).length > 0"
                                                    class="mt-2 p-2 bg-primary-container/10 dark:bg-primary-dark-container/10 rounded-md3 border border-primary/20">
                                                    <div
                                                        class="text-[10px] font-bold text-primary dark:text-primary-dark mb-1 flex justify-between">
                                                        <span>ÂåπÈÖçÁªìÊûú ({{ getFilteredNodesPreview(rule.regex).length
                                                            }})</span>
                                                    </div>
                                                    <div class="flex flex-wrap gap-1">
                                                        <span
                                                            v-for="tag in getFilteredNodesPreview(rule.regex).slice(0, 10)"
                                                            :key="tag"
                                                            class="text-[9px] bg-surface-container-highest dark:bg-surface-dark-container-highest px-1.5 py-0.5 rounded border border-outline-variant">
                                                            {{ tag }}
                                                        </span>
                                                        <span v-if="getFilteredNodesPreview(rule.regex).length > 10"
                                                            class="text-[9px] text-outline self-center">...</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div v-if="!config[1].filter?.country_filter?.length"
                                                class="text-center text-sm text-outline dark:text-outline-dark py-4">
                                                ÊöÇÊó†ËøáÊª§ËßÑÂàôÔºåËØ∑ÁÇπÂáªÂè≥‰∏äËßíÊ∑ªÂä†„ÄÇ
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Global Exclude -->
                                    <div
                                        class="p-4 rounded-md3-lg bg-surface-container dark:bg-surface-dark-container border border-outline-variant dark:border-outline-dark-variant shadow-md3-1">
                                        <div class="flex items-center justify-between mb-4">
                                            <h3 class="font-medium text-lg text-primary dark:text-primary-dark">Global
                                                Exclude
                                            </h3>
                                            <button @click="addExcludeRule"
                                                class="text-xs bg-primary dark:bg-primary-dark text-white px-3 py-1.5 rounded-md3-full hover:shadow-md3-2 transition-shadow">
                                                Ôºã Ê∑ªÂä†ÊéíÈô§
                                            </button>
                                        </div>

                                        <div class="space-y-2">
                                            <div v-for="(item, index) in config[1].filter?.excluded_outbounds"
                                                :key="index" class="flex items-center gap-2">
                                                <input type="text" v-model="config[1].filter.excluded_outbounds[index]"
                                                    placeholder="ÂÖ®Â±ÄÊéíÈô§Ê≠£Âàô..."
                                                    class="flex-1 text-sm px-3 py-2 rounded-md3 border border-outline-variant dark:border-outline-dark-variant bg-surface dark:bg-surface-dark focus:border-primary dark:focus:border-primary-dark outline-none font-mono transition-all">

                                                <button @click="removeExcludeRule(index)"
                                                    class="text-error hover:text-error-dark p-2 transition-colors"
                                                    title="Âà†Èô§ÊéíÈô§">
                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor"
                                                        viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                            <div v-if="!config[1].filter?.excluded_outbounds?.length"
                                                class="text-center text-sm text-outline dark:text-outline-dark py-4">
                                                ÊöÇÊó†ÂÖ®Â±ÄÊéíÈô§ËßÑÂàô
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Endpoints Section -->
                            <div id="section-endpoint" class="mb-6 scroll-mt-6">
                                <div class="flex items-center gap-3 mb-4">
                                    <span class="text-3xl">üìç</span>
                                    <h2 class="text-2xl font-bold text-primary dark:text-primary-dark">Endpoints</h2>
                                </div>

                                <div class="mb-4">
                                    <button @click="uiState.endpointsExpanded = !uiState.endpointsExpanded"
                                        class="w-full flex items-center justify-between mb-2 group">
                                        <h3
                                            class="text-sm font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wide">
                                            WireGuard / Tailscale (1.11.0+)
                                        </h3>
                                        <svg :class="['w-4 h-4 transition-transform duration-200 text-outline dark:text-outline-dark', uiState.endpointsExpanded ? 'rotate-180' : '']"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="border-t border-outline-variant dark:border-outline-dark-variant"></div>
                                </div>

                                <div v-show="uiState.endpointsExpanded" class="space-y-2 mb-6">
                                    <div v-for="(endpoint, index) in config[0].endpoints" :key="'endpoint-' + index"
                                        class="rounded-md3 border border-outline-variant dark:border-outline-dark-variant bg-surface-container dark:bg-surface-dark-container shadow-md3-1 hover:shadow-md3-2 transition-all">

                                        <!-- Header -->
                                        <div class="p-3 flex items-center justify-between cursor-pointer group"
                                            @click="toggleEndpointExpand(endpoint.tag)">
                                            <div class="flex items-center gap-2 flex-1">
                                                <span class="font-bold text-sm">{{ endpoint.tag || 'Êú™ÂëΩÂêçÁ´ØÁÇπ' }}</span>
                                                <span
                                                    class="text-xs px-2 py-0.5 rounded-md3-full bg-primary-container dark:bg-primary-dark-container">
                                                    {{ endpoint.type }}
                                                </span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <button @click.stop="deleteEndpoint(index)"
                                                    class="opacity-0 group-hover:opacity-100 w-6 h-6 flex items-center justify-center rounded-md3-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 transition-all">
                                                    <span class="text-sm">‚úï</span>
                                                </button>
                                                <svg :class="['w-4 h-4 transition-transform duration-200 text-outline', uiState.expandedEndpoints[endpoint.tag] ? 'rotate-180' : '']"
                                                    fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                </svg>
                                            </div>
                                        </div>

                                        <!-- Editor Body -->
                                        <div v-show="uiState.expandedEndpoints[endpoint.tag]" class="px-3 pb-3">
                                            <textarea :value="JSON.stringify(endpoint, null, 2)"
                                                class="w-full h-48 bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors font-mono text-xs"
                                                placeholder="JSON configuration"></textarea>
                                            <div class="mt-2 flex justify-end">
                                                <button
                                                    @click="confirmEndpointSave(endpoint.tag, $event.target.parentElement.previousElementSibling.value)"
                                                    class="px-4 py-2 bg-primary dark:bg-primary-dark text-white rounded-md3 text-xs font-bold shadow-md3-1 hover:shadow-md3-2 transition-all">
                                                    Á°ÆÂÆöÂπ∂‰øùÂ≠ò
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <button @click="addEndpoint"
                                        class="w-full p-3 rounded-md3 bg-primary dark:bg-primary-dark hover:shadow-md3-3 text-white font-medium transition-all flex items-center justify-center gap-2">
                                        <span class="text-lg">+</span>
                                        <span>ÂàõÂª∫Êñ∞ Endpoint</span>
                                    </button>

                                    <div v-if="!config[0].endpoints?.length"
                                        class="text-center py-4 text-sm text-outline dark:text-outline-dark italic">
                                        Â∞öÊú™Ê∑ªÂä†‰ªª‰ΩïÁ´ØÁÇπÈÖçÁΩÆÔºà‰ªé 1.11.0 Ëµ∑Êé®Ëçê‰ΩøÁî®Ôºâ
                                    </div>
                                </div>
                            </div>

                            <div id="section-diy" class="mb-6 scroll-mt-6">
                                <h2
                                    class="text-2xl font-bold mb-4 text-primary dark:text-primary-dark flex items-center gap-2">
                                    <span>üëã</span> DIY
                                </h2>

                                <div class="mb-4">
                                    <button @click="uiState.diyExpanded = !uiState.diyExpanded"
                                        class="w-full flex items-center justify-between mb-2 group">
                                        <h3
                                            class="text-sm font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wide">
                                            Ëá™ÂÆö‰πâÈÖçÁΩÆ
                                        </h3>
                                        <svg :class="['w-4 h-4 transition-transform duration-200 text-outline dark:text-outline-dark', uiState.diyExpanded ? 'rotate-180' : '']"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="border-t border-outline-variant dark:border-outline-dark-variant"></div>
                                </div>

                                <div v-show="uiState.diyExpanded"
                                    class="p-4 rounded-md3-lg bg-surface-container dark:bg-surface-dark-container border border-outline-variant dark:border-outline-dark-variant shadow-md3-1">
                                    <div class="mb-4">
                                        <label
                                            class="block text-sm font-medium mb-2 text-outline dark:text-outline-dark">Target
                                            Section : ÁõÆÊ†áÂå∫Âüü</label>
                                        <select v-model="currentDiySection"
                                            class="w-full bg-surface-container-high dark:bg-surface-dark-container-high p-3 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark outline-none transition-colors appearance-none cursor-pointer">
                                            <option value="log">Log (Êó•Âøó)</option>
                                            <option value="dns">DNS (ÂüüÂêçËß£Êûê)</option>
                                            <option value="inbounds">Inbounds (ÂÖ•Á´ô)</option>
                                            <option value="outbounds">Outbounds (Âá∫Á´ô)</option>
                                            <option value="route">Route (Ë∑ØÁî±)</option>
                                            <option value="experimental">Experimental (ÂÆûÈ™åÊÄß)</option>
                                        </select>
                                    </div>
                                    <div class="mb-2">
                                        <label
                                            class="block text-sm font-medium mb-2 text-outline dark:text-outline-dark">JSON
                                            Editor : ÁºñËæëÂô®</label>
                                        <textarea v-model="diyContent"
                                            class="w-full h-96 font-mono text-xs p-3 rounded-md3 bg-surface-container-high dark:bg-surface-dark-container-high border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark outline-none resize-y transition-colors"
                                            spellcheck="false"></textarea>
                                    </div>
                                    <div v-if="diyError"
                                        class="text-error dark:text-error-dark text-sm mt-2 font-medium bg-error-container dark:bg-error-dark-container p-2 rounded-md3">
                                        ‚ö†Ô∏è JSON Syntax Error: {{ diyError }}
                                    </div>
                                    <div v-else
                                        class="text-primary dark:text-primary-dark text-xs mt-2 flex items-center gap-1">
                                        <span>‚úÖ</span> Changes are applied automatically as you type (if valid JSON).
                                    </div>
                                </div>
                            </div>
                            <div id="section-import-export" class="mb-6 scroll-mt-6">
                                <h2
                                    class="text-2xl font-bold mb-4 text-primary dark:text-primary-dark flex items-center gap-2">
                                    <span>‚¨ÜÔ∏è</span> Import&Export
                                </h2>

                                <div class="mb-4">
                                    <button @click="uiState.importExportExpanded = !uiState.importExportExpanded"
                                        class="w-full flex items-center justify-between mb-2 group">
                                        <h3
                                            class="text-sm font-bold text-gray-900 dark:text-gray-100 uppercase tracking-wide">
                                            ÂØºÂÖ•‰∏éÂØºÂá∫
                                        </h3>
                                        <svg :class="['w-4 h-4 transition-transform duration-200 text-outline dark:text-outline-dark', uiState.importExportExpanded ? 'rotate-180' : '']"
                                            fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </button>
                                    <div class="border-t border-outline-variant dark:border-outline-dark-variant"></div>
                                </div>

                                <div v-show="uiState.importExportExpanded" class="flex flex-col gap-6">
                                    <!-- Import Card -->
                                    <div
                                        class="p-4 rounded-md3-lg bg-surface-container dark:bg-surface-dark-container border border-outline-variant dark:border-outline-dark-variant shadow-md3-1">
                                        <h3
                                            class="text-lg font-bold mb-4 text-primary dark:text-primary-dark flex items-center gap-2">
                                            <span>üì•</span>ÂØºÂÖ•ËÆæÁΩÆ
                                        </h3>

                                        <div class="space-y-4">
                                            <!-- URL Import -->
                                            <div>
                                                <label
                                                    class="block text-xs font-medium mb-1.5 text-outline dark:text-outline-dark">‰ªéÈìæÊé•ÂØºÂÖ•</label>
                                                <div class="flex gap-2">
                                                    <input type="text" v-model="uiState.importUrl"
                                                        placeholder="https://example.com/config.json"
                                                        class="flex-1 bg-surface-container-high dark:bg-surface-dark-container-high p-2.5 rounded-md3 border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors text-sm">
                                                    <button @click="importFromUrl" :disabled="uiState.importing"
                                                        class="px-4 py-2 bg-primary dark:bg-primary-dark text-white rounded-md3 hover:shadow-md3-2 transition-all disabled:opacity-50 text-sm font-medium">
                                                        {{ uiState.importing ? '...' : 'ÂØºÂÖ•ÈÖçÁΩÆ' }}
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- File Import -->
                                            <div>
                                                <label
                                                    class="block text-xs font-medium mb-1.5 text-outline dark:text-outline-dark">‰ªéÊñá‰ª∂ÂØºÂÖ•</label>
                                                <input type="file" @change="importFromFile" accept=".json,.jsonc"
                                                    class="w-full text-sm text-outline dark:text-outline-dark file:mr-4 file:py-2 file:px-4 file:rounded-md3 file:border-0 file:text-sm file:font-semibold file:bg-primary-container dark:file:bg-primary-dark-container file:text-primary dark:file:text-primary-dark hover:file:bg-primary-container-highest transition-colors cursor-pointer">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Export Card -->
                                    <div
                                        class="p-4 rounded-md3-lg bg-surface-container dark:bg-surface-dark-container border border-outline-variant dark:border-outline-dark-variant shadow-md3-1 flex flex-col justify-between">
                                        <div>
                                            <h3
                                                class="text-lg font-bold mb-4 text-primary dark:text-primary-dark flex items-center gap-2">
                                                <span>üì§</span> ÂØºÂá∫ËÆæÁΩÆ
                                            </h3>
                                            <p class="text-sm text-outline dark:text-outline-dark mb-6">
                                                ‰∏ãËΩΩÂΩìÂâçÈÖçÁΩÆÊàñ‰øùÂ≠òÂà∞ÊúçÂä°Âô®„ÄÇ
                                            </p>
                                        </div>

                                        <div class="flex flex-col gap-2">
                                            <button @click="saveToServer(false)" :disabled="uiState.saving"
                                                class="w-full py-3 bg-primary dark:bg-primary-dark text-white rounded-md3 hover:shadow-md3-2 transition-all flex items-center justify-center gap-2 font-bold disabled:opacity-50">
                                                <span v-if="uiState.saving">Saving...</span>
                                                <template v-else>
                                                    <span>üíæ</span> ‰øùÂ≠òËÆæÁΩÆ
                                                </template>
                                            </button>

                                            <button @click="exportToJson"
                                                class="w-full py-3 bg-secondary-container dark:bg-secondary-dark-container text-secondary dark:text-secondary-light rounded-md3 hover:shadow-md3-1 transition-all flex items-center justify-center gap-2 font-bold">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2"
                                                        d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4">
                                                    </path>
                                                </svg>
                                                ‰∏ãËΩΩ JSON
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
            </section>

            <section class="w-1/2 bg-surface-dark flex flex-col shadow-md3-3">
                <div
                    class="h-14 flex items-center justify-between px-6 bg-surface-dark-container border-b border-outline-dark-variant">
                    <div class="flex items-center gap-3">
                        <div class="flex space-x-1.5">
                            <div class="w-3 h-3 rounded-full bg-red-500"></div>
                            <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                        </div>
                        <span class="text-xs font-mono text-outline-dark uppercase tracking-wide">config.json</span>
                    </div>
                    <div class="flex gap-2">
                        <button @click="resetJson"
                            class="bg-primary dark:bg-primary-dark hover:shadow-md3-2 text-white px-2.5 py-1 rounded-md3-full text-xs font-medium transition-all uppercase tracking-wide">ÈáçÁΩÆ</button>
                        <button @click="copyJson"
                            class="bg-primary dark:bg-primary-dark hover:shadow-md3-2 text-white px-2.5 py-1 rounded-md3-full text-xs font-medium transition-all uppercase tracking-wide">Â§çÂà∂</button>
                    </div>
                </div>

                <div class="flex-1 p-6 overflow-auto custom-scrollbar">
                    <pre class="font-mono text-sm leading-relaxed text-primary-dark"><code>{{ finalJson }}</code></pre>
                </div>
            </section>
        </main>

        <div v-if="uiState.showInboundTypeModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
            @click.self="uiState.showInboundTypeModal = false">
            <div
                class="bg-surface dark:bg-surface-dark-container rounded-md3-xl shadow-md3-5 w-96 max-h-[600px] flex flex-col">
                <div class="p-6 border-b border-outline-variant dark:border-outline-dark-variant">
                    <h3 class="text-xl font-bold text-primary dark:text-primary-dark">ÈÄâÊã© Inbound Á±ªÂûã</h3>
                    <p class="text-xs text-outline dark:text-outline-dark mt-1">ÊêúÁ¥¢ÊàñÁÇπÂáªÈÄâÊã©</p>
                </div>

                <div class="p-4 border-b border-outline-variant dark:border-outline-dark-variant">
                    <input v-model="uiState.inboundTypeSearch" type="text" placeholder="ÊêúÁ¥¢Á±ªÂûã..."
                        class="w-full p-3 rounded-md3 bg-surface-container-high dark:bg-surface-dark-container-high border border-outline-variant dark:border-outline-dark-variant focus:border-primary dark:focus:border-primary-dark focus:outline-none transition-colors"
                        autofocus>
                </div>

                <div class="flex-1 overflow-y-auto p-2">
                    <button v-for="type in filteredInboundTypes" :key="type" @click="selectInboundType(type)"
                        class="w-full text-left px-4 py-3 rounded-md3 hover:bg-primary-container dark:hover:bg-primary-dark-container transition-colors mb-1 flex items-center justify-between group">
                        <span class="font-medium">{{ type }}</span>
                        <span class="text-xs opacity-0 group-hover:opacity-100 transition-opacity">‚Üí</span>
                    </button>
                </div>

                <div class="p-4 border-t border-outline-variant dark:border-outline-dark-variant flex justify-end">
                    <button @click="uiState.showInboundTypeModal = false"
                        class="px-6 py-2 rounded-md3-full bg-surface-container-high dark:bg-surface-dark-container-high hover:bg-surface-container-highest dark:hover:bg-surface-dark-container-highest transition-colors font-medium text-sm">
                        ÂèñÊ∂à
                    </button>
                </div>
            </div>
        </div>

        <!-- Outbound Ê∑ªÂä†Ê®°ÊÄÅÊ°Ü -->
        <div v-if="uiState.showAddOutboundModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
            @click.self="uiState.showAddOutboundModal = false">
            <div
                class="bg-surface dark:bg-surface-dark-container rounded-md3-xl shadow-md3-5 w-96 max-h-[600px] flex flex-col">
                <div class="p-6 border-b border-outline-variant dark:border-outline-dark-variant">
                    <h3 class="text-xl font-bold text-primary dark:text-primary-dark">Ê∑ªÂä†Âà∞ {{ uiState.currentGroup }}
                    </h3>
                    <p class="text-xs text-outline dark:text-outline-dark mt-1">ÈÄâÊã©Êú™ÂàÜÁ±ªÁöÑ Outbound</p>
                </div>

                <div class="flex-1 overflow-y-auto p-2">
                    <button v-for="outbound in getUncategorizedOutbounds()" :key="outbound.tag"
                        @click="addToGroup(uiState.currentGroup, outbound.tag)"
                        class="w-full text-left px-4 py-3 rounded-md3 hover:bg-primary-container dark:hover:bg-primary-dark-container transition-colors mb-1 flex items-center justify-between group">
                        <div class="flex items-center gap-2">
                            <span class="font-medium">{{ outbound.tag }}</span>
                            <span
                                class="text-xs px-2 py-0.5 rounded-md3-full bg-surface-container-high dark:bg-surface-dark-container-high">
                                {{ outbound.type }}
                            </span>
                        </div>
                        <span class="text-xs opacity-0 group-hover:opacity-100 transition-opacity">‚Üí</span>
                    </button>
                    <div v-if="getUncategorizedOutbounds().length === 0"
                        class="text-center py-8 text-outline dark:text-outline-dark text-sm">
                        Ê≤°ÊúâÊú™ÂàÜÁ±ªÁöÑ Outbound
                    </div>
                </div>

                <div class="p-4 border-t border-outline-variant dark:border-outline-dark-variant flex justify-end">
                    <button @click="uiState.showAddOutboundModal = false"
                        class="px-6 py-2 rounded-md3-full bg-surface-container-high dark:bg-surface-dark-container-high hover:bg-surface-container-highest dark:hover:bg-surface-dark-container-highest transition-colors font-medium text-sm">
                        ÂèñÊ∂à
                    </button>
                </div>
            </div>
        </div>

        <!-- Outbound Selector Modal (for Rule Set binding) -->
        <div v-if="uiState.showOutboundSelectorModal"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
            @click.self="uiState.showOutboundSelectorModal = false">
            <div
                class="bg-surface dark:bg-surface-dark-container rounded-md3-xl shadow-md3-5 w-96 max-h-[600px] flex flex-col">
                <div class="p-6 border-b border-outline-variant dark:border-outline-dark-variant">
                    <h3 class="text-xl font-bold text-primary dark:text-primary-dark">ÈÄâÊã© Outbound</h3>
                    <p class="text-xs text-outline dark:text-outline-dark mt-1">‰∏∫ Rule Set ÁªëÂÆö Outbound</p>
                </div>

                <div class="flex-1 overflow-y-auto p-2">
                    <button v-for="outbound in getAvailableOutbounds" :key="outbound"
                        @click="handleOutboundSelection(outbound)"
                        class="w-full text-left px-4 py-3 rounded-md3 hover:bg-primary-container dark:hover:bg-primary-dark-container transition-colors mb-1 flex items-center justify-between group">
                        <span class="font-medium">{{ outbound }}</span>
                        <span class="text-xs opacity-0 group-hover:opacity-100 transition-opacity">+</span>
                    </button>
                </div>

                <div class="p-4 border-t border-outline-variant dark:border-outline-dark-variant flex justify-end">
                    <button @click="uiState.showOutboundSelectorModal = false"
                        class="px-6 py-2 rounded-md3-full bg-surface-container-high dark:bg-surface-dark-container-high hover:bg-surface-container-highest dark:hover:bg-surface-dark-container-highest transition-colors font-medium text-sm">
                        ÂÖ≥Èó≠
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, watch } = Vue;

        createApp({
            setup() {
                const isDark = ref(false);

                const tabs = [
                    { id: 'log', name: 'Logging', icon: 'üìù' },
                    { id: 'dns', name: 'DNS Settings', icon: 'üåê' },
                    { id: 'inbound', name: 'Inbounds', icon: 'üì•' },
                    { id: 'outbound', name: 'Outbounds', icon: 'üì§Ô∏è' },
                    { id: 'endpoint', name: 'Endpoints', icon: 'üìç' },
                    { id: 'route', name: 'Route', icon: 'üß≠' },
                    { id: 'experiments', name: 'Experiments', icon: 'üß™' },
                    { id: 'filter', name: 'Filter', icon: 'üï∏' },
                    { id: 'diy', name: 'DIY', icon: 'üëã' },
                    { id: 'import-export', name: 'Import & Export', icon: '‚¨ÜÔ∏è' }
                ];

                // ÂàùÂßãÂåñÈÖçÁΩÆÊï∞ÊçÆ
                // config[0]: Sing-box Config
                // config[1]: App Settings (Github Proxy, etc.)
                const config = ref([{}, {
                    githubProxy: true,
                    githubProxyUrl: "https://gh-proxy.com/"
                }]);
                const configLoaded = ref(false);
                let serverConfig = null; // Store pure server response
                let defaultConfig = null; // Store session start state
                const STORAGE_KEY = 'singbox_config_draft';

                // 1. È¶ñÂÖàËé∑ÂèñÂéüÂßãÊ®°ÊùøÁî®‰∫éÈáçÁΩÆÂäüËÉΩ
                fetch('./configReset')
                    .then(res => res.json())
                    .then(baseline => {
                        serverConfig = JSON.parse(JSON.stringify(baseline));
                        // 2. ÁÑ∂ÂêéËé∑ÂèñÊúçÂä°Âô®‰øùÂ≠òÁöÑÂΩìÂâçÈÖçÁΩÆ
                        return fetch('./fetchConfig');
                    })
                    .then(response => response.json())
                    .then(data => {
                        const localDraft = localStorage.getItem(STORAGE_KEY);
                        let finalData = data;
                        if (localDraft) {
                            try {
                                finalData = JSON.parse(localDraft);
                            } catch (e) {
                                finalData = data;
                            }
                        }

                        // ËµãÂÄºÂà∞ Vue ÂìçÂ∫îÂºèÊï∞ÊçÆ
                        if (Array.isArray(finalData)) {
                            config.value = finalData;
                        } else {
                            config.value[0] = finalData;
                        }

                        // Á°Æ‰øù config[0].endpoints Â≠òÂú®‰∏î‰∏∫Êï∞ÁªÑ (1.11.0+)
                        if (!config.value[0].endpoints || typeof config.value[0].endpoints !== 'object' || !Array.isArray(config.value[0].endpoints)) {
                            config.value[0].endpoints = [];
                        }

                        // Á°Æ‰øù config[1] (Â∫îÁî®ËÆæÁΩÆ) ÂèäÂÖ∂Êò†Â∞ÑË°®Â≠òÂú®
                        if (!config.value[1]) {
                            config.value[1] = {
                                githubProxy: true,
                                githubProxyUrl: "https://gh-proxy.com/",
                                outboundGroupMap: {},
                                ruleset_outbound_map: {}
                            };
                        } else {
                            if (!config.value[1].outboundGroupMap) config.value[1].outboundGroupMap = {};
                            if (!config.value[1].ruleset_outbound_map) config.value[1].ruleset_outbound_map = {};
                        }

                        configLoaded.value = true;
                        defaultConfig = JSON.parse(JSON.stringify(config.value));
                    })
                    .catch(error => {
                        console.error('Failed to load config:', error);
                        // Êèê‰æõÈªòËÆ§ÈÖçÁΩÆ
                        config.value[0] = {
                            log: { disabled: false, level: 'info', output: 'box.log' },
                            dns: { servers: [], rules: [] },
                            inbounds: [],
                            outbounds: []
                        };
                        // Default App Settings
                        if (!config.value[1]) {
                            config.value[1] = {
                                githubProxy: true,
                                githubProxyUrl: "https://gh-proxy.com/",
                                outboundGroupMap: {},
                                ruleset_outbound_map: {}
                            };
                        }
                        // Ensure maps exist if config[1] was present but partial
                        if (!config.value[1].outboundGroupMap) config.value[1].outboundGroupMap = {};
                        if (!config.value[1].ruleset_outbound_map) config.value[1].ruleset_outbound_map = {};

                        configLoaded.value = true;
                        defaultConfig = JSON.parse(JSON.stringify(config.value));
                    });

                // UI ‰∏ìÁî®Áä∂ÊÄÅ
                const uiState = ref({
                    enableAuth: false,
                    dnsServersExpanded: true,
                    dnsOtherExpanded: true,
                    inboundsExpanded: true,
                    outboundAppExpanded: true,      // Â∫îÁî®ËßÑÂàôÂ±ïÂºÄÁä∂ÊÄÅ
                    outboundRegionExpanded: true,   // Âú∞Âå∫ÂàÜÁ±ªÂ±ïÂºÄÁä∂ÊÄÅ
                    outboundBasicExpanded: true,    // Âü∫Êú¨ÂàÜÁªÑÂ±ïÂºÄÁä∂ÊÄÅ
                    outboundCustomExpanded: true,   // Ëá™ÂÆö‰πâ Outbound Â±ïÂºÄÁä∂ÊÄÅ
                    expandedOutbounds: {},          // ËÆ∞ÂΩïÂì™‰∫õ outbound ÊòØÂ±ïÂºÄÁöÑ
                    endpointsExpanded: true,        // Endpoints Âå∫ÂüüÂ±ïÂºÄÁä∂ÊÄÅ
                    expandedEndpoints: {},          // ËÆ∞ÂΩïÂì™‰∫õ endpoint ÊòØÂ±ïÂºÄÁöÑ
                    expandedRuleSets: {},           // ËÆ∞ÂΩïÂì™‰∫õ rule set ÊòØÂ±ïÂºÄÁöÑ
                    ruleSetsExpanded: true,         // Rule Sets Âå∫ÂüüÂ±ïÂºÄÁä∂ÊÄÅ
                    showInboundTypeModal: false,
                    showAddOutboundModal: false,    // ÊòæÁ§∫Ê∑ªÂä† Outbound Ê®°ÊÄÅÊ°Ü
                    showOutboundSelectorModal: false, // ÊòæÁ§∫ Outbound ÈÄâÊã©Âô®Ê®°ÊÄÅÊ°Ü
                    fetchedNodes: [],               // ÊäìÂèñÁöÑ‰∏¥Êó∂ËäÇÁÇπ (Áî®‰∫éÈ¢ÑËßà)
                    currentGroup: '',               // ÂΩìÂâçË¶ÅÊ∑ªÂä†Âà∞ÁöÑÂàÜÁªÑ
                    currentRulesetForBinding: '',   // ÂΩìÂâçË¶ÅÁªëÂÆö outbound ÁöÑ rule set
                    selectingForFilterIndex: null,  // ÂΩìÂâçÊ≠£Âú®‰∏∫Âì™‰∏™ Filter Rule ÈÄâÊã© Outbound (index)
                    manualOutboundInput: {},        // ÊâãÂä®ËæìÂÖ•ÁöÑ outbound ÂêçÁß∞
                    showDIYModal: true,
                    showRouteModal: true,
                    showExperimentsModal: true,
                    showFilterModal: true,
                    inboundTypeSearch: '',
                    importUrl: '',
                    importing: false,
                    saving: false,
                    experimentalExpanded: true,
                    filterExpanded: true,
                    diyExpanded: true,
                    importExportExpanded: true,
                });

                const isDirty = ref(false);

                // Watch and save to local
                // Watch and save to local + auto-save to server
                watch(config, (newVal) => {
                    if (configLoaded.value) {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(newVal));
                        isDirty.value = true;
                        autoSave();
                    }
                }, { deep: true });

                // Outbound ÂàÜÁªÑÊò†Â∞Ñ (tag -> group) - Ëá™Âä®ÂàùÂßãÂåñÂàÜÁ±ª
                // Persisted in config[1].outboundGroupMap
                const outboundGroupMap = computed({
                    get: () => config.value[1]?.outboundGroupMap || {},
                    set: (val) => { if (config.value[1]) config.value[1].outboundGroupMap = val; }
                });

                // Ëá™Âä®ÂàÜÁ±ªÂáΩÊï∞
                const autoCategorizOutbounds = () => {
                    // Fix: Access config[0].outbounds
                    if (!config.value[0]?.outbounds) return;

                    // ÂÆö‰πâÂàÜÁ±ªËßÑÂàô
                    const regionKeywords = ['È¶ôÊ∏Ø', 'Êó•Êú¨', 'ÁãÆÂüé', 'ÁæéÂõΩ', 'Âè∞Êπæ'];
                    const basicKeywords = ['ÊºèÁΩë‰πãÈ±º', 'ÈªòËÆ§‰ª£ÁêÜ', 'ÂÖ®ÁêÉÁõ¥Ëøû', 'Ëá™Âä®ÈÄâÊã©', 'ÊâãÂä®ÈÄâÊã©', 'Âª∂ËøüËæÖÂä©', 'ÂÖ®Â±Ä‰ª£ÁêÜ'];

                    config.value[0].outbounds.forEach(outbound => {
                        const tag = outbound.tag || '';

                        // If already categorized (loaded from JSON), skip
                        if (outboundGroupMap.value[tag]) return;

                        // Âú∞Âå∫ÂàÜÁ±ª
                        if (regionKeywords.some(keyword => tag.includes(keyword))) {
                            outboundGroupMap.value[tag] = 'Âú∞Âå∫ÂàÜÁ±ª';
                        }
                        // Âü∫Êú¨ÂàÜÁªÑ
                        else if (basicKeywords.some(keyword => tag.includes(keyword))) {
                            outboundGroupMap.value[tag] = 'Âü∫Êú¨ÂàÜÁªÑ';
                        }
                        // ÂÖ∂‰ªñÈÉΩÂΩíÂÖ•Â∫îÁî®ËßÑÂàô (‰ªÖÈíàÂØπÈÄâÊã©Âô®ÁªÑÔºåÂçïËäÇÁÇπ‰∏çËá™Âä®ÂàÜÁ±ª)
                        else {
                            const groupingTypes = ['selector', 'urltest', 'fallback', 'balancer'];
                            if (groupingTypes.includes(outbound.type)) {
                                outboundGroupMap.value[tag] = 'Â∫îÁî®ËßÑÂàô';
                            }
                        }
                    });
                };
                const ruleset_outbound_map = computed({
                    get: () => config.value[1]?.ruleset_outbound_map || {},
                    set: (val) => { if (config.value[1]) config.value[1].ruleset_outbound_map = val; }
                });

                // Ê£ÄÊµãÈÖçÁΩÆ‰∏≠Áé∞ÊúâÁöÑ‰ª£ÁêÜËÆæÁΩÆ
                const detectProxySettings = () => {
                    if (!config.value[0].route?.rule_set) return;

                    for (const ruleset of config.value[0].route.rule_set) {
                        if (ruleset.type === 'remote' && ruleset.url) {
                            const githubIndex = ruleset.url.indexOf('https://github.com');
                            const rawGithubIndex = ruleset.url.indexOf('https://raw.githubusercontent.com');

                            // ÊâæÂà∞‰∏Ä‰∏™ÊòØ GitHub ‰ΩÜÊúâÂâçÁºÄÁöÑ URL
                            if (githubIndex > 0 || rawGithubIndex > 0) {
                                const index = githubIndex > 0 ? githubIndex : rawGithubIndex;
                                const prefix = ruleset.url.substring(0, index);

                                // Êõ¥Êñ∞Áä∂ÊÄÅ
                                config.value[1].githubProxy = true;
                                config.value[1].githubProxyUrl = prefix;
                                return; // ÊâæÂà∞‰∏Ä‰∏™Â∞±Â§ü‰∫Ü
                            }
                        }
                    }
                    // Â¶ÇÊûúÊ≤°ÊâæÂà∞‰ªª‰Ωï‰ª£ÁêÜÂâçÁºÄÔºå‰ΩÜÊúâ GitHub URLÔºåÂàôÂèØËÉΩÊòØÊú™ÂºÄÂêØ‰ª£ÁêÜ
                    // ËøôÈáåÊàë‰ª¨‰øùÊåÅ githubProxy ÁöÑÈªòËÆ§ÂÄºÔºàtrueÔºâÊàñËÆæ‰∏∫ false
                    // ‰∏∫‰∫Ü‰∏çÊâìÊâ∞Áî®Êà∑ÔºåÂ¶ÇÊûúÂÖ®ÊòØÁõ¥Ëøû GitHubÔºåÊàë‰ª¨ÂèØ‰ª•ÊääÂÆÉËÆæ‰∏∫ false
                    const hasDirectGithub = config.value[0].route.rule_set.some(r =>
                        r.url && (r.url.startsWith('https://github.com') || r.url.startsWith('https://raw.githubusercontent.com'))
                    );

                    if (hasDirectGithub) {
                        config.value[1].githubProxy = false;
                    }
                };

                // ‰ªé route.rules ÂàùÂßãÂåñ ruleset_outbound_map
                const initializeRulesetMappings = () => {
                    // Respect persisted data
                    if (Object.keys(ruleset_outbound_map.value).length > 0) return;

                    if (!config.value[0].route?.rules) return;

                    ruleset_outbound_map.value = {};
                    config.value[0].route.rules.forEach(rule => {
                        if (rule.rule_set && rule.outbound) {
                            ruleset_outbound_map.value[rule.rule_set] = rule.outbound;
                        }
                    });
                };

                // ÂàùÂßãÂåñ Experimental ÈÖçÁΩÆ
                // ÂàùÂßãÂåñ Experimental ÈÖçÁΩÆ
                const initializeExperimentalConfig = () => {
                    if (!config.value[0].experimental) config.value[0].experimental = {};

                    // Clash API
                    if (!config.value[0].experimental.clash_api) config.value[0].experimental.clash_api = {};
                    const clashApi = config.value[0].experimental.clash_api;

                    if (!clashApi.external_controller) clashApi.external_controller = "0.0.0.0:9095";
                    if (!clashApi.external_ui) clashApi.external_ui = "ui";
                    if (!clashApi.external_ui_download_url) clashApi.external_ui_download_url = "https://github.com/Zephyruso/zashboard/archive/refs/heads/gh-pages.zip";
                    if (!clashApi.external_ui_download_detour) clashApi.external_ui_download_detour = "üéØ ÂÖ®ÁêÉÁõ¥Ëøû";
                    if (!clashApi.default_mode) clashApi.default_mode = "rule";

                    // Cache File
                    if (!config.value[0].experimental.cache_file) config.value[0].experimental.cache_file = {};
                    const cacheFile = config.value[0].experimental.cache_file;

                    if (cacheFile.enabled === undefined) cacheFile.enabled = true;
                    if (cacheFile.store_fakeip === undefined) cacheFile.store_fakeip = false;
                    if (!cacheFile.path) cacheFile.path = './cache.db';
                };

                // ÁõëÂê¨ÈÖçÁΩÆÂä†ËΩΩÂÆåÊàêÂêéËá™Âä®ÂàÜÁ±ª
                watch(configLoaded, (loaded) => {
                    if (loaded) {
                        autoCategorizOutbounds();
                        initializeRulesetMappings();
                        initializeExperimentalConfig();
                        detectProxySettings(); // Ê£ÄÊµã‰ª£ÁêÜËÆæÁΩÆ
                    }
                });

                // const tempAuth = ref({ username: "admin", password: "password" });

                const options = {
                    levels: ["race", "debug", "info", "warn", "error", "fatal", "panic"],
                    dnsStrategies: ["prefer_ipv4", "prefer_ipv6", "ipv4_only", "ipv6_only"],
                    inboundTypes: [
                        "direct", "mixed", "socks", "http", "shadowsocks",
                        "vmess", "trojan", "naive", "hysteria", "shadowtls",
                        "tuic", "hysteria2", "vless", "anytls", "tun",
                        "redirect", "tproxy"
                    ],
                    outboundGroup: [
                        "Â∫îÁî®ËßÑÂàô", "Âú∞Âå∫ÂàÜÁ±ª", "Âü∫Êú¨ÂàÜÁªÑ"
                    ],
                    outboundGroupType: [
                        "urltest", "selector"
                    ],
                    dnsServerTypes: ["udp", "https", "tls", "quic", "dhcp", "local", "fakeip"],
                    clashApi_mode: ["rule", "direct", "global"]
                };

                // ÂàùÂßãÂåñ Filter ÈÖçÁΩÆ
                const initializeFilterConfig = () => {
                    if (!config.value[1]) config.value[1] = {}; // Safety check
                    if (!config.value[1].filter) config.value[1].filter = {};

                    if (!config.value[1].filter.country_filter) {
                        config.value[1].filter.country_filter = [
                            { outbound: "üá≠üá∞ È¶ôÊ∏ØËá™Âä®", regex: "(?i)Ê∏Ø|hk|hongkong|hong\\s*kong" },
                            { outbound: "üáØüáµ Êó•Êú¨Ëá™Âä®", regex: "(?i)Êó•|jp|japan|japanese" },
                            { outbound: "üá∏üá¨ ÁãÆÂüéËá™Âä®", regex: "(?i)Êñ∞Âä†Âù°|Âù°|ÁãÆÂüé|SG|Singapore" },
                            { outbound: "üá∫üá∏ ÁæéÂõΩËá™Âä®", regex: "(?i)Áæé|us|usa|united|america" },
                            { outbound: "üá¨üáß Ëã±ÂõΩËá™Âä®", regex: "(?i)Ëã±|uk|united\\s*kingdom|great\\s*britain" },
                            { outbound: "üá∞üá∑ Èü©ÂõΩËá™Âä®", regex: "(?i)Èü©|kr|korea" },
                            { outbound: "üáπüáº Âè∞ÊπæËá™Âä®", regex: "(?i)Âè∞|tw|taiwan" }
                        ];
                    }

                    if (!config.value[1].filter.excluded_outbounds) {
                        config.value[1].filter.excluded_outbounds = [];
                    }
                };

                const addFilterRule = () => {
                    if (!config.value[1].filter.country_filter) config.value[1].filter.country_filter = [];
                    config.value[1].filter.country_filter.push({ outbound: "", regex: "" });
                };

                const removeFilterRule = (index) => {
                    config.value[1].filter.country_filter.splice(index, 1);
                };

                const addExcludeRule = () => {
                    if (!config.value[1].filter.excluded_outbounds) config.value[1].filter.excluded_outbounds = [];
                    config.value[1].filter.excluded_outbounds.push("");
                };

                const removeExcludeRule = (index) => {
                    config.value[1].filter.excluded_outbounds.splice(index, 1);
                };

                // ÊâìÂºÄ Outbound ÈÄâÊã©Âô®Áî®‰∫é Filter
                const openFilterOutboundSelector = (index) => {
                    uiState.value.selectingForFilterIndex = index;
                    uiState.value.showOutboundSelectorModal = true;
                };

                // Â§ÑÁêÜ Modal ‰∏≠ÁöÑ Outbound ÈÄâÊã©
                const handleOutboundSelection = (outboundTag) => {
                    if (uiState.value.selectingForFilterIndex !== undefined && uiState.value.selectingForFilterIndex !== null) {
                        // ÊòØ‰∏∫ Filter ÈÄâÊã©
                        const idx = uiState.value.selectingForFilterIndex;
                        if (config.value[1].filter?.country_filter?.[idx]) {
                            config.value[1].filter.country_filter[idx].outbound = outboundTag;
                        }
                        uiState.value.showOutboundSelectorModal = false;
                        uiState.value.selectingForFilterIndex = null;
                    } else if (uiState.value.currentRulesetForBinding) {
                        // ÊòØ‰∏∫ Rule Set ÁªëÂÆö
                        bindOutboundToRuleset(uiState.value.currentRulesetForBinding, outboundTag);
                    }
                };

                // ÁõëÂê¨ÈÖçÁΩÆÂä†ËΩΩÂÆåÊàêÂêéËá™Âä®ÂàÜÁ±ª
                watch(configLoaded, (loaded) => {
                    if (loaded) {
                        autoCategorizOutbounds();
                        initializeRulesetMappings();
                        initializeExperimentalConfig();
                        initializeFilterConfig();
                        detectProxySettings(); // Ê£ÄÊµã‰ª£ÁêÜËÆæÁΩÆ
                    }
                });

                // ËøáÊª§ÂêéÁöÑ Inbound Á±ªÂûãÂàóË°®
                const filteredInboundTypes = computed(() => {
                    const search = uiState.value.inboundTypeSearch.toLowerCase();
                    if (!search) return options.inboundTypes;
                    return options.inboundTypes.filter(type => type.toLowerCase().includes(search));
                });

                // Â§ÑÁêÜ Optional ÈÄªËæëÔºöÂêàÂπ∂Êï∞ÊçÆ
                // ÁßªÈô§‰∫Ü highlightedJsonÔºå‰øùÁïô finalJson Áî®‰∫éÊòæÁ§∫
                const finalJson = computed(() => {
                    if (!config.value) return "";
                    // Output the Full Array [config, settings]
                    // This allows persistence of filter/proxy settings to te.json
                    return JSON.stringify(config.value, null, 4);
                });

                const toggleDarkMode = () => {
                    isDark.value = !isDark.value;
                    if (isDark.value) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                };

                const copyJson = () => {
                    navigator.clipboard.writeText(finalJson.value);
                    alert("JSON Â∑≤Â§çÂà∂");
                };

                // ÊªöÂä®Âà∞ÊåáÂÆöÂå∫Âùó
                const scrollToSection = (sectionId) => {
                    const element = document.getElementById(`section-${sectionId}`);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                };

                // Ê∑ªÂä† Inbound - ÊâìÂºÄÈÄâÊã©Ê®°ÊÄÅÊ°Ü
                const addInbound = () => {
                    if (!config.value[0].inbounds) {
                        config.value[0].inbounds = [];
                    }
                    uiState.value.inboundTypeSearch = ''; // Ê∏ÖÁ©∫ÊêúÁ¥¢
                    uiState.value.showInboundTypeModal = true; // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                };

                // ÈÄâÊã© Inbound Á±ªÂûã
                const selectInboundType = (type) => {
                    config.value[0].inbounds.push({
                        type: type
                    });
                    uiState.value.showInboundTypeModal = false; // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                };

                // Âà†Èô§ Inbound
                const deleteInbound = (index) => {
                    if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÂÖ•Á´ôÈÖçÁΩÆÂêóÔºü')) {
                        config.value[0].inbounds.splice(index, 1);
                    }
                };

                // Êõ¥Êñ∞ Inbound JSON
                const updateInbound = (index, jsonString) => {
                    try {
                        const parsed = JSON.parse(jsonString);
                        config.value[0].inbounds[index] = parsed;
                    } catch (e) {
                        // JSON Ê†ºÂºèÈîôËØØÔºå‰∏çÊõ¥Êñ∞
                        console.error('Invalid JSON:', e);
                    }
                };
                // ==========================
                // Endpoints ÁÆ°ÁêÜ (1.11.0+)
                // ==========================
                const addEndpoint = () => {
                    if (!config.value[0].endpoints) {
                        config.value[0].endpoints = [];
                    }
                    const timestamp = Date.now();
                    const newEndpoint = {
                        type: "wireguard",
                        tag: `wg-${timestamp}`,
                        system: false,
                        address: ["10.0.0.2/32"]
                    };
                    config.value[0].endpoints.push(newEndpoint);
                    uiState.value.expandedEndpoints[newEndpoint.tag] = true;
                };

                const deleteEndpoint = (index) => {
                    if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Á´ØÁÇπÈÖçÁΩÆÂêóÔºü')) {
                        config.value[0].endpoints.splice(index, 1);
                    }
                };

                const confirmEndpointSave = (oldTag, jsonString) => {
                    try {
                        const parsed = JSON.parse(jsonString);
                        if (!parsed.tag || parsed.tag.trim() === "") {
                            alert("Tag ‰∏çËÉΩ‰∏∫Á©∫");
                            return;
                        }

                        const index = config.value[0].endpoints.findIndex(e => e.tag === oldTag);
                        if (index === -1) {
                            alert("Êú™ÊâæÂà∞ÂéüÁ´ØÁÇπ");
                            return;
                        }

                        // Â¶ÇÊûú‰øÆÊîπ‰∫Ü TagÔºåÊõ¥Êñ∞ Outbounds ‰∏≠ÁöÑÂºïÁî®
                        if (parsed.tag !== oldTag) {
                            if (config.value[0].outbounds) {
                                config.value[0].outbounds.forEach(o => {
                                    if (o.endpoint === oldTag) {
                                        o.endpoint = parsed.tag;
                                    }
                                });
                            }
                        }

                        config.value[0].endpoints[index] = parsed;

                        // Ê∏ÖÁêÜÂ±ïÂºÄÁä∂ÊÄÅÂπ∂ÈáçÊñ∞‰ª•Êñ∞ tag Â±ïÂºÄÔºàÂ¶ÇÊûú tag Âèò‰∫ÜÔºâ
                        if (parsed.tag !== oldTag) {
                            delete uiState.value.expandedEndpoints[oldTag];
                            uiState.value.expandedEndpoints[parsed.tag] = true;
                        }

                        alert(`Â∑≤‰øùÂ≠òÁ´ØÁÇπ "${parsed.tag}"`);
                    } catch (e) {
                        alert("JSON Ê†ºÂºèÈîôËØØ: " + e.message);
                    }
                };

                const toggleEndpointExpand = (tag) => {
                    if (uiState.value.expandedEndpoints[tag]) {
                        delete uiState.value.expandedEndpoints[tag];
                    } else {
                        uiState.value.expandedEndpoints[tag] = true;
                    }
                };

                const ChangeGithubProxy = (proxyUrl) => {
                    config.value[1].githubProxyUrl = proxyUrl;
                    for (let i of config.value[0].route.rule_set) {
                        if (i.type === 'http') {
                            i.url = proxyUrl + i.url.split("https://github.com")[1];
                        }
                    }
                };

                // ÁõëÂê¨ GitHub ‰ª£ÁêÜÂ§çÈÄâÊ°ÜÁä∂ÊÄÅ
                // ÁõëÂê¨ GitHub ‰ª£ÁêÜËÆæÁΩÆÂèòÂåñÔºàÂºÄÂÖ≥Êàñ URLÔºâ
                watch(() => [config.value[1]?.githubProxy, config.value[1]?.githubProxyUrl], ([proxyEnabled, proxyUrl]) => {
                    if (!config.value[0].route?.rule_set) return;

                    config.value[0].route.rule_set.forEach(ruleset => {
                        if (ruleset.type === 'remote' && ruleset.url) {
                            // Â∞ùËØïÊâæÂà∞ÂéüÂßã GitHub URL
                            let rawUrl = ruleset.url;
                            const githubIndex = ruleset.url.indexOf('https://github.com');
                            const rawGithubIndex = ruleset.url.indexOf('https://raw.githubusercontent.com');

                            if (githubIndex !== -1) {
                                rawUrl = ruleset.url.substring(githubIndex);
                            } else if (rawGithubIndex !== -1) {
                                rawUrl = ruleset.url.substring(rawGithubIndex);
                            } else {
                                // ‰∏çÊòØ GitHub URLÔºåË∑≥Ëøá
                                return;
                            }

                            // Á°Æ‰øù proxyUrl ‰ª• / ÁªìÂ∞æÔºàÂ¶ÇÊûúÁî®Êà∑Ê≤°ËæìÔºâ
                            let safeProxyUrl = proxyUrl || '';
                            if (safeProxyUrl && !safeProxyUrl.endsWith('/')) {
                                safeProxyUrl += '/';
                            }

                            if (proxyEnabled) {
                                ruleset.url = safeProxyUrl + rawUrl;
                            } else {
                                ruleset.url = rawUrl;
                            }
                        }
                    });
                });
                // Outbound ÂàÜÁªÑÁÆ°ÁêÜÂáΩÊï∞
                const getOutboundsByGroup = (groupName) => {
                    if (!config.value[0].outbounds) return [];
                    return config.value[0].outbounds.filter(outbound =>
                        outboundGroupMap.value[outbound.tag] === groupName
                    );
                };

                const getUncategorizedOutbounds = () => {
                    if (!config.value[0].outbounds) return [];
                    return config.value[0].outbounds.filter(outbound =>
                        !outboundGroupMap.value[outbound.tag]
                    );
                };

                const showAddOutboundModal = (groupName) => {
                    uiState.value.currentGroup = groupName;
                    uiState.value.showAddOutboundModal = true;
                };

                const addToGroup = (groupName, tag) => {
                    outboundGroupMap.value[tag] = groupName;
                    uiState.value.showAddOutboundModal = false;
                };

                const removeFromGroup = (groupName, tag) => {
                    if (confirm(`Á°ÆÂÆöË¶ÅÂ∞Ü "${tag}" ‰ªé "${groupName}" ‰∏≠ÁßªÈô§ÂêóÔºü`)) {
                        delete outboundGroupMap.value[tag];
                    }
                };

                // ÂàáÊç¢ Outbound Â±ïÂºÄÁä∂ÊÄÅ
                const toggleOutboundExpand = (tag) => {
                    if (uiState.value.expandedOutbounds[tag]) {
                        delete uiState.value.expandedOutbounds[tag];
                    } else {
                        uiState.value.expandedOutbounds[tag] = true;
                    }
                };

                // Á°ÆËÆ§Âπ∂‰øùÂ≠òËá™ÂÆö‰πâ Outbound
                const confirmCustomOutbound = (oldTag, jsonString) => {
                    try {
                        const parsed = JSON.parse(jsonString);
                        if (!parsed.tag || parsed.tag.trim() === "") {
                            alert("Tag ‰∏çËÉΩ‰∏∫Á©∫");
                            return;
                        }

                        // 1. Êõ¥Êñ∞‰∏ªÈÖçÁΩÆ‰∏≠ÁöÑÊï∞ÊçÆ
                        const index = config.value[0].outbounds.findIndex(o => o.tag === oldTag);
                        if (index === -1) {
                            alert("Êú™ÊâæÂà∞ÂéüËäÇÁÇπ");
                            return;
                        }

                        // 2. Â¶ÇÊûú‰øÆÊîπ‰∫Ü TagÔºåËøÅÁßªÂÖ≥ËÅîÁä∂ÊÄÅ
                        if (parsed.tag !== oldTag) {
                            if (outboundGroupMap.value[oldTag]) {
                                outboundGroupMap.value[parsed.tag] = outboundGroupMap.value[oldTag];
                            }
                            Object.keys(ruleset_outbound_map.value).forEach(key => {
                                if (ruleset_outbound_map.value[key] === oldTag) {
                                    ruleset_outbound_map.value[key] = parsed.tag;
                                }
                            });
                        }

                        // Êõ¥Êñ∞Êï∞ÊçÆÂØπË±°
                        config.value[0].outbounds[index] = parsed;

                        // 3. „ÄêÊ†∏ÂøÉ„ÄëÂ∞ÜËäÇÁÇπ‰ªéËá™ÂÆö‰πâÁßªÂä®Âà∞‚ÄúÊú™ÂàÜÁ±ª‚Äù
                        delete outboundGroupMap.value[parsed.tag];
                        delete outboundGroupMap.value[oldTag];

                        // 4. Êî∂Ëµ∑Âπ∂Ê∏ÖÁêÜÁä∂ÊÄÅ
                        delete uiState.value.expandedOutbounds[oldTag];
                        delete uiState.value.expandedOutbounds[parsed.tag];

                        alert(`Â∑≤‰øùÂ≠ò "${parsed.tag}" Âπ∂ÁßªÂä®Âà∞Êú™ÂàÜÁ±ªÂàóË°®`);
                    } catch (e) {
                        alert("JSON Ê†ºÂºèÈîôËØØ: " + e.message);
                    }
                };

                // Êõ¥Êñ∞ Outbound JSON
                const updateOutbound = (tag, jsonString) => {
                    try {
                        const parsed = JSON.parse(jsonString);
                        const index = config.value[0].outbounds.findIndex(o => o.tag === tag);
                        if (index !== -1) {
                            config.value[0].outbounds[index] = parsed;
                        }
                    } catch (e) { }
                };


                // ÂàõÂª∫Êñ∞ÁöÑËá™ÂÆö‰πâ Outbound
                const createNewOutbound = () => {
                    const timestamp = Date.now();
                    const newOutbound = {
                        tag: `custom-outbound-${timestamp}`,
                        type: "selector",
                        outbounds: []
                    };
                    config.value[0].outbounds.push(newOutbound);
                    outboundGroupMap.value[newOutbound.tag] = 'Ëá™ÂÆö‰πâ';
                    // Ëá™Âä®Â±ïÂºÄÊñ∞ÂàõÂª∫ÁöÑ outbound
                    uiState.value.expandedOutbounds[newOutbound.tag] = true;
                };

                // Âà†Èô§Ëá™ÂÆö‰πâ Outbound
                const deleteCustomOutbound = (tag) => {
                    if (confirm(`Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ "${tag}" ÂêóÔºü\n\nÊ≠§Êìç‰ΩúÂ∞Ü‰ªéÈÖçÁΩÆ‰∏≠ÂÆåÂÖ®ÁßªÈô§ËØ• outboundÔºåÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ`)) {
                        const index = config.value[0].outbounds.findIndex(o => o.tag === tag);
                        if (index !== -1) {
                            config.value[0].outbounds.splice(index, 1);
                            delete outboundGroupMap.value[tag];
                            delete uiState.value.expandedOutbounds[tag];
                        }
                    }
                };

                // Rule Set ÁÆ°ÁêÜÂáΩÊï∞
                const getRuleSets = computed(() => {
                    return config.value[0].route?.rule_set || [];
                });

                const getAvailableOutbounds = computed(() => {
                    if (!config.value[0].outbounds) return [];
                    return config.value[0].outbounds.map(o => o.tag);
                });

                const getRulesetOutbounds = (rulesetTag) => {
                    return ruleset_outbound_map.value[rulesetTag] || null;
                };

                const bindOutboundToRuleset = (rulesetTag, outboundTag) => {
                    ruleset_outbound_map.value[rulesetTag] = outboundTag;
                    uiState.value.showOutboundSelectorModal = false;
                };

                const unbindOutboundFromRuleset = (rulesetTag) => {
                    delete ruleset_outbound_map.value[rulesetTag];
                };

                const bindManualOutbound = (rulesetTag) => {
                    const outboundTag = uiState.value.manualOutboundInput[rulesetTag]?.trim();
                    if (!outboundTag) return;

                    ruleset_outbound_map.value[rulesetTag] = outboundTag;
                    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
                    uiState.value.manualOutboundInput[rulesetTag] = '';
                };

                const toggleRuleSetExpand = (tag) => {
                    if (uiState.value.expandedRuleSets[tag]) {
                        delete uiState.value.expandedRuleSets[tag];
                    } else {
                        uiState.value.expandedRuleSets[tag] = true;
                    }
                };

                const updateRuleSet = (tag, jsonString) => {
                    try {
                        const parsed = JSON.parse(jsonString);
                        const index = config.value[0].route.rule_set.findIndex(r => r.tag === tag);
                        if (index !== -1) {
                            config.value[0].route.rule_set[index] = parsed;
                        }
                    } catch (e) {
                        console.error('Invalid JSON:', e);
                    }
                };

                const createNewRuleSet = () => {
                    const timestamp = Date.now();
                    const newRuleSet = {
                        tag: `custom-ruleset-${timestamp}`,
                        type: "remote",
                        format: "binary",
                        url: "https://example.com/ruleset.srs",
                        download_detour: "üéØ ÂÖ®ÁêÉÁõ¥Ëøû"
                    };
                    if (!config.value[0].route) {
                        config.value[0].route = {};
                    }
                    if (!config.value[0].route.rule_set) {
                        config.value[0].route.rule_set = [];
                    }
                    config.value[0].route.rule_set.push(newRuleSet);
                    // Ëá™Âä®Â±ïÂºÄÊñ∞ÂàõÂª∫ÁöÑ rule set
                    uiState.value.expandedRuleSets[newRuleSet.tag] = true;
                };

                const deleteRuleSet = (tag) => {
                    if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ Rule Set "${tag}" ÂêóÔºü\n\nÊ≠§Êìç‰ΩúÂ∞Ü‰ªéÈÖçÁΩÆ‰∏≠ÂÆåÂÖ®ÁßªÈô§ËØ• rule setÔºåÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ`)) {
                        const index = config.value[0].route.rule_set.findIndex(r => r.tag === tag);
                        if (index !== -1) {
                            config.value[0].route.rule_set.splice(index, 1);
                            delete ruleset_outbound_map.value[tag];
                            delete uiState.value.expandedRuleSets[tag];
                        }
                    }
                };

                // DIY Section Logic
                const currentDiySection = ref('log');
                const diyError = ref('');

                const diyContent = computed({
                    get: () => {
                        const section = config.value[0][currentDiySection.value];
                        return JSON.stringify(section || {}, null, 4);
                    },
                    set: (val) => {
                        try {
                            const parsed = JSON.parse(val);
                            config.value[0][currentDiySection.value] = parsed;
                            diyError.value = '';
                        } catch (e) {
                            diyError.value = e.message;
                        }
                    }
                });

                // Import/Export Logic
                const importFromUrl = async () => {
                    const url = uiState.value.importUrl?.trim();
                    if (!url) return;

                    uiState.value.importing = true;
                    try {
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const data = await response.json();

                        if (Array.isArray(data)) {
                            config.value = data;
                        } else {
                            config.value[0] = data;
                        }
                        alert("ÈÖçÁΩÆÂ∑≤ÊàêÂäü‰ªé URL ÂØºÂÖ•");
                    } catch (e) {
                        alert(`ÂØºÂÖ•Â§±Ë¥•: ${e.message}`);
                    } finally {
                        uiState.value.importing = false;
                    }
                };

                const importFromFile = (event) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (Array.isArray(data)) {
                                config.value = data;
                            } else {
                                config.value[0] = data;
                            }
                            alert("ÈÖçÁΩÆÂ∑≤ÊàêÂäü‰ªéÊñá‰ª∂ÂØºÂÖ•");
                        } catch (err) {
                            alert("Êó†ÊïàÁöÑ JSON Êñá‰ª∂");
                        }
                    };
                    reader.readAsText(file);
                };

                const exportToJson = () => {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config.value, null, 4));
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", "sing-box-config.json");
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                };

                const fetchProxies = async () => {
                    const urls = uiState.value.importUrl?.trim();
                    if (!urls) return;

                    uiState.value.importing = true;
                    try {
                        const response = await fetch(`/cus/fetch_proxies?urls=${encodeURIComponent(urls)}`);
                        const data = await response.json();
                        if (data.success) {
                            uiState.value.fetchedNodes = data.proxies;
                        } else {
                            throw new Error(data.error || "Ëé∑ÂèñËäÇÁÇπÂ§±Ë¥•");
                        }
                    } catch (e) {
                        alert(`Â§±Ë¥•: ${e.message}`);
                    } finally {
                        uiState.value.importing = false;
                    }
                };

                const mergeFetchedNodes = () => {
                    if (!uiState.value.fetchedNodes?.length) return;
                    if (confirm(`Ë¶ÅÂ∞ÜËøô ${uiState.value.fetchedNodes.length} ‰∏™ËäÇÁÇπÂêàÂπ∂Âà∞ÂΩìÂâçÈÖçÁΩÆÂêóÔºü`)) {
                        if (!config.value[0].outbounds) config.value[0].outbounds = [];
                        const existingTags = new Set(config.value[0].outbounds.map(o => o.tag));
                        const newNodes = uiState.value.fetchedNodes.filter(p => !existingTags.has(p.tag));
                        config.value[0].outbounds.push(...newNodes);
                        alert(`Â∑≤ÂêàÂπ∂ ${newNodes.length} ‰∏™Êñ∞ËäÇÁÇπ`);
                        uiState.value.fetchedNodes = []; // Clear after merge
                    }
                };

                const getFilteredNodesPreview = (regexStr) => {
                    if (!regexStr) return [];
                    const nodes = uiState.value.fetchedNodes?.length > 0
                        ? uiState.value.fetchedNodes
                        : (config.value[0].outbounds || []);

                    let pattern = regexStr;
                    let flags = "u";
                    if (pattern.includes("(?i)")) {
                        pattern = pattern.replace(/\(\?i\)/g, "");
                        flags += "i";
                    }

                    try {
                        if (!pattern) return nodes.map(n => n.tag);
                        const regex = new RegExp(pattern, flags.includes("i") ? "iu" : "u");
                        return nodes
                            .map(n => n.tag)
                            .filter(tag => typeof tag === 'string' && regex.test(tag));
                    } catch (e) {
                        return [];
                    }
                };

                const debounce = (func, wait) => {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                };

                const saveToServer = async (isAutoSave = false) => {
                    if (!isAutoSave) {
                        uiState.value.saving = true;
                    }

                    try {
                        const response = await fetch('/cus/save', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(config.value)
                        });
                        const result = await response.json();
                        if (result.success) {
                            if (!isAutoSave) {
                                isDirty.value = false;
                                alert("ÈÖçÁΩÆÂ∑≤ÊàêÂäü‰øùÂ≠òÂà∞ÊúçÂä°Âô®");
                                localStorage.removeItem(STORAGE_KEY);
                                window.location.href = './index.html';
                            } else {
                                console.log("Auto-save successful");
                            }
                        } else {
                            throw new Error(result.error || "‰øùÂ≠òÂ§±Ë¥•");
                        }
                    } catch (e) {
                        if (!isAutoSave) {
                            alert(`‰øùÂ≠òÂ§±Ë¥•: ${e.message}`);
                        } else {
                            console.warn("Auto-save failed:", e);
                        }
                    } finally {
                        if (!isAutoSave) {
                            uiState.value.saving = false;
                        }
                    }
                };

                const autoSave = debounce(() => {
                    saveToServer(true);
                }, 2000);

                // Add beforeunload listener inside setup to access isDirty ref
                window.addEventListener('beforeunload', (e) => {
                    if (isDirty.value) {
                        e.preventDefault();
                        e.returnValue = '';
                    }
                });
                const resetJson = () => {
                    if (serverConfig && confirm("Á°ÆÂÆöË¶ÅÈáçÁΩÆÈÖçÁΩÆÂêóÔºü\nËøôÂ∞ÜÊ∏ÖÈô§Êú¨Âú∞ÁºìÂ≠òÂπ∂ÊÅ¢Â§çÂà∞ÊúçÂä°Âô®ÂéüÂßãÈÖçÁΩÆÔºåÊâÄÊúâÊú™‰øùÂ≠òÁöÑ‰øÆÊîπÂ∞Ü‰∏¢Â§±„ÄÇ")) {
                        // Restore from server config
                        config.value = JSON.parse(JSON.stringify(serverConfig));

                        // Clear local storage
                        localStorage.removeItem(STORAGE_KEY);

                        // Reset dirty state
                        setTimeout(() => { isDirty.value = false; }, 100);

                        alert("ÈÖçÁΩÆÂ∑≤ÈáçÁΩÆ‰∏∫ÊúçÂä°Âô®ÈªòËÆ§Áä∂ÊÄÅ");
                    }
                };
                return {
                    isDark, tabs, config, options, configLoaded,
                    uiState, finalJson,

                    toggleDarkMode, copyJson, scrollToSection,
                    addInbound, deleteInbound, updateInbound, resetJson,
                    filteredInboundTypes, selectInboundType,
                    getOutboundsByGroup, getUncategorizedOutbounds,
                    showAddOutboundModal, addToGroup, removeFromGroup,
                    toggleOutboundExpand, updateOutbound, confirmCustomOutbound,
                    createNewOutbound, deleteCustomOutbound,
                    getRuleSets, getAvailableOutbounds, getRulesetOutbounds,
                    bindOutboundToRuleset, unbindOutboundFromRuleset, bindManualOutbound,
                    toggleRuleSetExpand, updateRuleSet,
                    createNewRuleSet, deleteRuleSet,
                    addEndpoint, deleteEndpoint, confirmEndpointSave, toggleEndpointExpand,
                    addFilterRule, removeFilterRule, addExcludeRule, removeExcludeRule,
                    openFilterOutboundSelector, handleOutboundSelection,
                    currentDiySection, diyError, diyContent,
                    importFromUrl, importFromFile, fetchProxies, mergeFetchedNodes, getFilteredNodesPreview, exportToJson, saveToServer, isDirty
                };
            }
        }).mount('#app');
    </script>

    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #938F99;
            border-radius: 999px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #79747E;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
    </style>
</body>

</html>